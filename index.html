<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCA Insight Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... (‡∏Ñ‡∏á Style ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ) ... */
        body { font-family: 'Sarabun', sans-serif; background-color: #F8FAFC; color: #334155; }
        .chart-container { position: relative; width: 100%; max-width: 100%; height: 300px; }
        @media (min-width: 768px) { .chart-container { height: 500px; } }
        .rca-table, .action-table, .initiative-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; margin-top: 10px; margin-bottom: 20px; }
        .rca-table th, .action-table th, .initiative-table th { color: white; padding: 10px; text-align: left; border: 1px solid #e2e8f0; }
        .rca-table th { background-color: #F59E0B; }
        .action-table th { background-color: #0EA5E9; }
        .initiative-table th { background-color: #7C3AED; }
        .rca-table td, .action-table td, .initiative-table td { border: 1px solid #e2e8f0; padding: 10px; vertical-align: top; }
        tr:nth-child(even) { background-color: #f8fafc; }
        .fishbone-grid { display: grid; grid-template-columns: repeat(1, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        @media (min-width: 768px) { .fishbone-grid { grid-template-columns: repeat(2, 1fr); } }
        .fishbone-card { background-color: #fff; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .fishbone-header { font-weight: bold; color: #475569; border-bottom: 2px solid #cbd5e1; padding-bottom: 0.5rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .why-step { display: flex; align-items: flex-start; margin-bottom: 0.5rem; position: relative; }
        .why-number { background-color: #EC4899; color: white; font-weight: bold; border-radius: 50%; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; font-size: 0.75rem; margin-right: 0.75rem; flex-shrink: 0; z-index: 10; }
        .why-line { position: absolute; left: 11px; top: 24px; bottom: -10px; width: 2px; background-color: #FBCFE8; z-index: 0; }
        .why-step:last-child .why-line { display: none; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #0EA5E9; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-slate-50">

    <header class="relative w-full h-32 bg-gradient-to-r from-slate-800 to-slate-900 shadow-xl overflow-hidden mb-8">
        <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
            <div class="absolute top-10 left-10 w-64 h-64 bg-teal-500 rounded-full filter blur-3xl"></div>
            <div class="absolute bottom-10 right-10 w-64 h-64 bg-blue-500 rounded-full filter blur-3xl"></div>
        </div>

        <div class="absolute top-6 right-6 flex items-center gap-4 z-20">
            <div class="flex gap-2">
                <img src="https://flagcdn.com/h40/th.png" alt="Thailand" title="Thailand" class="h-6 rounded shadow-lg opacity-90 hover:opacity-100 hover:scale-110 transition-transform duration-200">
                <img src="https://flagcdn.com/h40/my.png" alt="Malaysia" title="Malaysia" class="h-6 rounded shadow-lg opacity-90 hover:opacity-100 hover:scale-110 transition-transform duration-200">
                <img src="https://flagcdn.com/h40/ph.png" alt="Philippines" title="Philippines" class="h-6 rounded shadow-lg opacity-90 hover:opacity-100 hover:scale-110 transition-transform duration-200">
                <img src="https://flagcdn.com/h40/bn.png" alt="Brunei" title="Brunei" class="h-6 rounded shadow-lg opacity-90 hover:opacity-100 hover:scale-110 transition-transform duration-200">
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 -mt-20 pb-16 space-y-24 max-w-6xl relative z-20">

        <section id="ai-lab">
            <div class="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-3xl p-1 shadow-2xl transform hover:scale-[1.01] transition-transform duration-300">
                <div class="bg-white rounded-[20px] p-6 md:p-10">
                    <div class="text-center mb-10">
                        <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">Interactive Support</span>
                        <h2 class="text-3xl md:text-4xl font-extrabold text-slate-800 mt-4 mb-2 flex items-center justify-center gap-3">
                            <span>‚ú®</span> RCA Insight Companion
                        </h2>
                        <p class="text-slate-500 max-w-2xl mx-auto">
                            Your supportive partner for deep learning, root cause analysis, and creating safer systems together.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                        <div class="space-y-6">
                            <div class="bg-slate-50 rounded-2xl p-6 border border-slate-200 shadow-sm hover:shadow-md transition duration-300">
                                <h3 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2">
                                    <span class="text-2xl">üè•</span> 1. Hospital Risk or Incident Report
                                </h3>
                                <p class="text-xs text-slate-500 mb-3">Describe the incident. We will help you visualize the root causes.</p>
                                <textarea id="scenarioInput" class="w-full p-4 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-amber-500 outline-none transition shadow-inner mb-4 bg-white" rows="3" placeholder="Example: Nurse administered wrong medication due to similar packaging and high workload..."></textarea>
                                
                                <button id="combinedRunButton" onclick="startFullAnalysis()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-xl transition shadow-lg hover:shadow-amber-500/30 flex justify-center items-center gap-2 transform active:scale-95">
                                    <span id="runSpinner" class="loader hidden border-white border-t-amber-800"></span>
                                    <span>üîç Root Cause Analysis</span>
                                </button>
                                
                                <div id="analyzeResult" class="mt-4 p-4 bg-white rounded-xl text-sm text-slate-700 hidden border border-amber-100 shadow-inner"></div>
                            </div>
                        </div>
                        <div class="bg-blue-50 rounded-2xl p-6 border-2 border-blue-100 shadow-md relative overflow-hidden h-full">
                            <div class="absolute top-0 right-0 bg-blue-200 text-blue-800 text-[10px] font-bold px-2 py-1 rounded-bl-lg">STEP 2 (Automatic)</div>
                            <h3 class="text-lg font-bold text-blue-900 mb-3 flex items-center gap-2">
                                <span class="text-2xl">üéØ</span> 2. Action Plan & KPIs
                            </h3>
                            <p class="text-xs text-blue-700 mb-4">The system generates 3 key parts: PDSA, Action Plan, and Initiative Ideas.</p>
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Input Data:</label>
                            <textarea id="planInput" class="w-full p-4 border border-blue-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none h-40 bg-white mb-4 shadow-inner font-mono text-slate-600" placeholder="Waiting for analysis results..."></textarea>
                            <div class="flex gap-2">
                                <button onclick="exportToWord()" class="w-full bg-white hover:bg-slate-50 text-blue-700 border border-blue-200 font-bold py-3 px-4 rounded-xl transition shadow-md flex justify-center items-center gap-2 transform active:scale-95" title="Export to Word">
                                    <span class="text-lg">üìÑ</span>
                                    <span class="md:inline">Export Word</span>
                                </button>
                            </div>
                            <div id="planResult" class="mt-6 p-5 bg-white rounded-xl text-sm text-slate-700 border border-blue-100 shadow-lg min-h-[100px] hidden overflow-x-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-20 flex items-center justify-center">
                <div class="h-px w-24 bg-slate-300"></div>
                <span class="px-4 text-slate-400 text-sm font-semibold tracking-wider uppercase">Deep Dive Knowledge</span>
                <div class="h-px w-24 bg-slate-300"></div>
            </div>
        </section>

        <section>
             <div class="text-center mb-12"><h2 class="text-3xl font-bold text-slate-800">1. Core Concepts in Depth</h2></div>
             </section>

        <section class="bg-white rounded-3xl shadow-xl p-8 md:p-12 border border-slate-200">
             <h2 class="text-3xl font-bold text-slate-800">2. Assessment & Status</h2>
             <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
                 <div class="lg:col-span-5 space-y-6">
                      <div class="bg-slate-100 p-4 rounded-xl border border-slate-200 max-h-[500px] overflow-y-auto">
                           <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Input % Positive Response</h4>
                            <div><div class="flex justify-between mb-1"><label class="text-slate-700 font-semibold text-xs">1. Teamwork</label><span id="val-0" class="text-teal-600 font-bold text-xs">0.00%</span></div><input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(0, this.value)"></div>
                            <div style="display:none;" id="hidden-sliders-placeholder">Please paste original sliders here</div>
                       </div>
                       <div class="chart-container mt-6"><canvas id="assessmentChart"></canvas></div>
                  </div>
                  <div class="lg:col-span-7 space-y-6">
                      <h3 class="xl font-bold text-slate-700 border-l-4 border-teal-500 pl-4">Gap Analysis & Solutions</h3>
                       </div>
             </div>
        </section>

        <section class="py-8">
            <div class="text-center mb-12"><h2 class="text-3xl font-bold text-slate-800">3. Implementation Roadmap</h2></div>
             </section>

    </main>

    <footer class="bg-slate-900 py-12 border-t border-slate-800 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-slate-400 text-sm mb-2">¬© 2026 Healthcare Safety Series.</p>
            <p class="text-slate-600 text-xs">Empowering Healthcare Professionals in ASEAN</p>
        </div>
    </footer>

    <script>
        // --- Core Gemini API Call Function (UPDATED) ---
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ localStorage ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÅ‡∏ó‡∏ô
        async function callGemini(prompt) {
            try {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á Endpoint ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô server.js
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(`Server Error: ${errData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google: candidates[0].content.parts[0].text
                return data.candidates[0].content.parts[0].text;

            } catch (error) { 
                console.error(error);
                throw error; 
            }
        }

        // --- 1. Combined Workflow Starter ---
        async function startFullAnalysis() {
            const input = document.getElementById('scenarioInput').value;
            const runButton = document.getElementById('combinedRunButton');
            const spinner = document.getElementById('runSpinner');
            const resultDiv = document.getElementById('analyzeResult');
            const planInput = document.getElementById('planInput');
            const planResultDiv = document.getElementById('planResult');
            
            if (!input.trim()) { alert("Please enter a scenario."); return; }

            // 1. Start UI feedback
            runButton.disabled = true;
            spinner.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            planResultDiv.classList.add('hidden');
            planResultDiv.innerHTML = '';
            planInput.value = 'Analyzing and generating plan... Please wait.';
            planInput.classList.remove('ring-4', 'ring-green-300', 'bg-green-50');

            try {
                // --- STEP 1: Analyze Risk ---
                const analysisData = await analyzeRiskStep(input);
                
                // Display analysis result
                resultDiv.innerHTML = analysisData.html;
                resultDiv.classList.remove('hidden');
                
                // Prepare data for Step 2
                const autoFilledContent = `[Scenario]\n${input}\n\n[Risk Analysis Results]\n${analysisData.cleanText}`;
                planInput.value = autoFilledContent;
                
                // --- STEP 2: Generate Action Plan (Automatic) ---
                planInput.value = 'Analysis complete... Generating detailed Action Plan...';
                const actionPlanHTML = await generateActionPlanStep(autoFilledContent);

                // Display action plan result
                planResultDiv.innerHTML = actionPlanHTML;
                planResultDiv.classList.remove('hidden');

                // Success Feedback
                planInput.value = '‚úî Action Plan Generated Successfully';
                planInput.classList.add('ring-4', 'ring-green-300', 'bg-green-50');
                // Auto-scroll to the result
                planResultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

                setTimeout(() => { planInput.classList.remove('ring-4', 'ring-green-300', 'bg-green-50'); }, 1500);

            } catch (error) {
                console.error("Full analysis failed:", error);
                alert("Error during analysis: " + error.message);
                planInput.value = `Error: ${error.message}`;
            } finally {
                // 3. End UI feedback
                spinner.classList.add('hidden');
                runButton.disabled = false;
            }
        }

        // --- 1a. Analyze Risk Step (Private Function) ---
        async function analyzeRiskStep(input) {
            // (‡∏Ñ‡∏á Prompt ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ)
            const prompt = `Act as a Patient Safety Expert specializing in Root Cause Analysis (RCA).
            Analyze the following healthcare scenario in English: "${input}".
            
            Please provide the output in English using HTML format. Do not use Markdown code blocks.
            Follow this exact structure:
            
            <h3 class="font-bold text-lg text-teal-700 mb-2">1. Event Summary</h3>
            <p class="mb-2 text-slate-600">...Provide a narrative summary of the event...</p>
            <ul class="list-disc pl-5 mb-4 text-slate-600 space-y-1">
                <li>...Key point 1...</li>
                <li>...Key point 2...</li>
            </ul>

            <h3 class="font-bold text-lg text-teal-700 mb-2">2. Event Timeline</h3>
            <ol class="list-decimal pl-5 mb-4 text-slate-600 space-y-1">
                <li>...Detailed step 1...</li>
                <li>...Detailed step 2...</li>
            </ol>

            <h3 class="font-bold text-lg text-amber-700 mb-2">3. Fishbone Diagram Analysis (Ishikawa)</h3>
            <p class="text-xs text-slate-500 mb-3">Structured breakdown of root causes (6Ms)</p>
            <div class="fishbone-grid">
                <div class="fishbone-card"><div class="fishbone-header">üë§ Man (People)</div><ul class="list-disc pl-4 text-xs text-slate-600 space-y-1"><li>...Factor 1...</li><li>...Factor 2...</li></ul></div>
                <div class="fishbone-card"><div class="fishbone-header">‚öôÔ∏è Machine (Equipment)</div><ul class="list-disc pl-4 text-xs text-slate-600 space-y-1"><li>...Factor 1...</li><li>...Factor 2...</li></ul></div>
                <div class="fishbone-card"><div class="fishbone-header">üìù Method (Process)</div><ul class="list-disc pl-4 text-xs text-slate-600 space-y-1"><li>...Factor 1...</li><li>...Factor 2...</li></ul></div>
                <div class="fishbone-card"><div class="fishbone-header">üì¶ Material (Supplies)</div><ul class="list-disc pl-4 text-xs text-slate-600 space-y-1"><li>...Factor 1...</li><li>...Factor 2...</li></ul></div>
                <div class="fishbone-card"><div class="fishbone-header">üå°Ô∏è Environment</div><ul class="list-disc pl-4 text-xs text-slate-600 space-y-1"><li>...Factor 1...</li><li>...Factor 2...</li></ul></div>
                <div class="fishbone-card"><div class="fishbone-header">üìè Measurement</div><ul class="list-disc pl-4 text-xs text-slate-600 space-y-1"><li>...Factor 1...</li><li>...Factor 2...</li></ul></div>
            </div>

            <h3 class="font-bold text-lg text-pink-600 mb-2">4. 5 Whys Analysis</h3>
            <p class="text-xs text-slate-500 mb-3">Drilling down to the deepest root cause</p>
            <div class="bg-pink-50 p-4 rounded-lg border border-pink-100 mb-4">
                 <div class="why-step"><div class="why-number">1</div><div class="why-line"></div><div class="text-sm text-slate-700 pt-1">Why...</div></div>
                 <div class="why-step"><div class="why-number">2</div><div class="why-line"></div><div class="text-sm text-slate-700 pt-1">Why...</div></div>
                 <div class="why-step"><div class="why-number">3</div><div class="why-line"></div><div class="text-sm text-slate-700 pt-1">Why...</div></div>
                 <div class="why-step"><div class="why-number">4</div><div class="why-line"></div><div class="text-sm text-slate-700 pt-1">Why...</div></div>
                 <div class="why-step"><div class="why-number">5</div><div class="text-sm text-slate-700 pt-1 font-bold text-pink-700">Root Cause: ...</div></div>
            </div>

            <h3 class="font-bold text-lg text-amber-700 mb-2">5. Swiss Cheese Analysis (Layers)</h3>
            <table class="rca-table">
              <thead>
                <tr>
                    <th width="30%">System Layer</th>
                    <th width="20%">Type</th>
                    <th>Description</th>
                </tr>
              </thead>
              <tbody>
                <tr><td><strong>Organizational Influences</strong></td><td>Latent</td><td>...</td></tr>
                <tr><td><strong>Unsafe Supervision</strong></td><td>Latent</td><td>...</td></tr>
                <tr><td><strong>Preconditions</strong></td><td>Latent</td><td>...</td></tr>
                <tr><td><strong>Unsafe Acts</strong></td><td>Active</td><td>...</td></tr>
              </tbody>
            </table>`;

            const responseText = await callGemini(prompt);
            let formattedText = responseText.replace(/```html/g, '').replace(/```/g, '');
            const cleanText = responseText.replace(/<[^>]*>?/gm, ''); 
            
            if (formattedText.includes("Error") || formattedText.length < 50) {
                 throw new Error("Risk analysis failed");
            }

            return { html: formattedText, cleanText: cleanText };
        }

        // --- 1b. Action Plan Generation Step (Private Function) ---
        async function generateActionPlanStep(analysisData) {
            // (‡∏Ñ‡∏á Prompt ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ)
            const prompt = `Act as a Hospital Safety Manager. 
            Based on the analysis data: "${analysisData}".

            Create a comprehensive response in English HTML containing 3 distinct tables followed by a conclusion section.
            
            Part 1: PDSA Strategy Summary (Format: Blue Header, Expanded PDSA Detail)
            <h3 class="font-bold text-lg text-blue-700 mb-2">1. PDSA Strategy Summary</h3>
            <table class="action-table" style="width:100%; border-collapse: collapse; border: 1px solid #ddd;">
              <tr style="background-color:#0EA5E9; color: white;">
                 <th style="padding:10px;">Topic</th><th style="padding:10px;">Details</th>
              </tr>
              <tr><td><strong>Objective</strong></td><td>...</td></tr>
              <tr>
                <td><strong>PDSA Cycle</strong></td>
                <td>
                  <ul style="list-style-type: disc; margin-left: 20px; padding-left: 0;">
                    <li><strong>Plan:</strong> ...detailed planning activities...</li>
                    <li><strong>Do:</strong> ...key implementation actions...</li>
                    <li><strong>Study:</strong> ...critical metrics...</li>
                    <li><strong>Act:</strong> ...next cycle planning...</li>
                  </ul>
                </td>
              </tr>
              <tr><td><strong>Key KPIs</strong></td><td>...</td></tr>
            </table>

            Part 2: Detailed Action Plan (Format: Teal Header)
            <h3 class="font-bold text-lg text-teal-700 mt-6 mb-2">2. Detailed Action Plan</h3>
            <table class="action-table" style="width:100%; border-collapse: collapse; border: 1px solid #ddd;">
              <tr style="background-color:#0D9488; color: white;">
                 <th style="padding:10px;">Objective</th>
                 <th style="padding:10px;">Steps</th>
                 <th style="padding:10px;">KPIs</th>
                 <th style="padding:10px;">Target</th>
                 <th style="padding:10px;">Resources</th>
                 <th style="padding:10px;">Owner</th>
                 <th style="padding:10px;">Timeline</th>
              </tr>
              <tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
            </table>

            Part 3: Initiatives for Patient Safety (Format: Violet Header)
            <h3 class="font-bold text-lg text-purple-700 mt-6 mb-2">3. Innovative Safety Initiatives</h3>
            <table class="initiative-table" style="width:100%; border-collapse: collapse; border: 1px solid #ddd;">
              <tr style="background-color:#7C3AED; color: white;">
                 <th style="padding:10px;">No.</th>
                 <th style="padding:10px;">Initiative</th>
                 <th style="padding:10px;">Brief Description</th>
                 <th style="padding:10px;">How-to</th>
                 <th style="padding:10px;">Key Responsible</th>
                 <th style="padding:10px;">Expected Outcome</th>
              </tr>
              <tr><td>1</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
            </table>
            
            <h3 class="font-bold text-lg text-indigo-700 mt-6 mb-2">4. Conclusion & Recommendations</h3>
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-200 text-sm space-y-3">
                <p><strong>Key Actions Summary:</strong> ...</p>
                <p><strong>Lessons Learned:</strong> ...</p>
                <p><strong>Safety Culture Vision:</strong> ...</p>
            </div>`;

            const responseText = await callGemini(prompt);
            let formattedContent = responseText.replace(/```html/g, '').replace(/```/g, '');

            if (formattedContent.includes("Error") || formattedContent.length < 50) {
                 throw new Error("Action Plan generation failed");
            }
            
            return formattedContent;
        }

        // --- Feature 3: Export to Word ---
        function exportToWord() {
            const scenario = document.getElementById('scenarioInput').value;
            const riskAnalysis = document.getElementById('analyzeResult').innerHTML;
            const actionPlan = document.getElementById('planResult').innerHTML;

            if (!actionPlan || actionPlan.includes("loader") || document.getElementById('planInput').value.includes("Waiting")) { alert("Please complete the analysis and action plan generation first."); return; }

            const content = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset='utf-8'>
                    <title>Safety Action Plan</title>
                    <style>
                        body { font-family: 'Arial', 'Calibri', sans-serif; font-size: 11pt; line-height: 1.2; color: #333; }
                        h1 { color: #1e3a8a; text-align: center; font-size: 16pt; margin-bottom: 5px; font-weight: bold; }
                        h2 { color: #0f766e; border-bottom: 2px solid #0f766e; padding-bottom: 5px; margin-top: 25px; font-size: 14pt; font-weight: bold; }
                        h3 { color: #444; font-size: 12pt; margin-top: 20px; margin-bottom: 10px; font-weight: bold; }
                        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; font-size: 10pt; }
                        th, td { border: 1px solid #000; padding: 5px 10px; vertical-align: top; text-align: left; }
                        th { color: white; font-weight: bold; }
                        .rca-table th { background-color: #F59E0B; }
                        .action-table th { background-color: #0EA5E9; } 
                        .initiative-table th { background-color: #7C3AED; }
                        table:nth-of-type(1) th { background-color: #1e293b; }
                        .fishbone-grid { display: table; width: 100%; }
                        .fishbone-card { display: table-cell; border: 1px solid #ccc; padding: 10px; width: 30%; margin: 5px; }
                        ul, ol { margin: 0; padding-left: 25px; }
                        li { margin-bottom: 3px; }
                    </style>
                </head>
                <body>
                    <div style="text-align: right; font-size: 10pt; color: #666; margin-bottom: 20px;">Date: ${new Date().toLocaleDateString('en-US')}</div>
                    <h1>Safety Action Plan Report</h1>
                    <h2>1. Risk Analysis</h2>
                    <table><tr><th style="background-color:#1e293b;" width="20%">Scenario</th><td>${scenario || '-'}</td></tr></table>
                    ${riskAnalysis || '-'}
                    <h2>2. Action Plan & Initiatives</h2>
                    ${actionPlan}
                    <br><p style="text-align: center; font-size: 9pt; color: #999; margin-top:50px;">Document generated by RCA Insight Companion</p>
                </body>
                </html>
            `;
            const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Safety_Plan_Initiatives_${new Date().toISOString().slice(0,10)}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Charts (Standard)
        Chart.defaults.font.family = "'Sarabun', sans-serif";
        Chart.defaults.color = '#64748B';
        const ctx = document.getElementById('assessmentChart');
        const assessmentChart = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels: ['Teamwork', 'Staffing & Work Pace', 'Org. Learning', 'Response to Error', 'Supervisor Support', 'Comm. About Error', 'Comm. Openness', 'Reporting Events', 'Hospital Mgmt. Support', 'Handoffs & Info'], 
                datasets: [
                    { label: 'Your Hospital (% Positive)', data: [0,0,0,0,0,0,0,0,0,0], backgroundColor: '#0D9488', borderRadius: 4, barPercentage: 0.6 }, 
                    { label: 'Ideal Goal (100%)', data: [100,100,100,100,100,100,100,100,100,100], backgroundColor: '#E2E8F0', borderRadius: 4, barPercentage: 0.6, borderWidth: 1, borderColor: '#94A3B8' }
                ] 
            },
            options: { 
                indexAxis: 'y', responsive: true, maintainAspectRatio: false, 
                scales: { x: { suggestedMin: 0, max: 100, grid: { color: '#f1f5f9' }, title: { display: true, text: '% Positive Response' } }, y: { grid: { display: false } } }, 
                plugins: { tooltip: { callbacks: { title: ctx => Array.isArray(ctx[0].label) ? ctx[0].label.join(' ') : ctx[0].label, label: function(context) { return context.dataset.label + ': ' + context.parsed.x + '%'; } }, padding: 12, backgroundColor: '#1E293B' }, legend: { position: 'bottom' } } 
            }
        });

        function updateChartData(index, value) {
            document.getElementById(`val-${index}`).innerText = parseFloat(value).toFixed(2) + '%';
            assessmentChart.data.datasets[0].data[index] = value;
            assessmentChart.update();
        }
    </script>
</body>
</html>
