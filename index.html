<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCA インサイト・コンパニオン</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #F8FAFC; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #0EA5E9; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50">

    <main class="container mx-auto px-4 pt-10 pb-16 max-w-screen-2xl relative z-20">

        <section id="ai-lab">
            <div class="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-3xl p-1 shadow-2xl overflow-hidden">
                <div class="bg-white rounded-[20px] p-6 md:p-10">
                    
                    <div class="text-center mb-10">
                        <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">インタラクティブ・サポート</span>
                        <h2 class="text-3xl md:text-4xl font-extrabold text-slate-800 mt-4 mb-2 flex items-center justify-center gap-3">
                            <span>✨</span> RCA インサイト・コンパニオン
                        </h2>
                        <p class="text-slate-500 max-w-2xl mx-auto">
                            深い学習、根本原因分析、そして共により安全なシステムを構築するための、あなたの心強いパートナー。
                        </p>
                    </div>

                    <div class="flex flex-col gap-8 max-w-4xl mx-auto">

                        <div class="space-y-6">
                            <div class="bg-slate-50 rounded-2xl p-6 border border-slate-200 shadow-sm">
                                <h3 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2">
                                    <span class="text-2xl">🏥</span> 1. 病院のリスクまたはインシデント・レポート
                                </h3>
                                <textarea id="scenarioInput" class="w-full p-4 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-amber-500 outline-none mb-4 bg-white" rows="6" placeholder="インシデントの内容を入力してください..."></textarea>
                                
                                <button id="combinedRunButton" onclick="startFullAnalysis()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg flex justify-center items-center gap-2 transform active:scale-95">
                                    <span id="runSpinner" class="loader hidden border-white border-t-transparent"></span>
                                    <span>🔍 RCA分析を開始</span>
                                </button>
                                <div id="analyzeResult" class="hidden mt-4 p-4 text-sm text-slate-700 bg-white rounded-xl border border-amber-100 overflow-x-auto"></div>
                            </div>
                        </div>
                        </div>

                        <div class="bg-blue-50 rounded-2xl p-6 border-2 border-blue-100 shadow-md relative overflow-hidden h-full">
                            <div class="absolute top-0 right-0 bg-blue-200 text-blue-800 text-[10px] font-bold px-2 py-1 rounded-bl-lg">ステップ 2 (自動)</div>
                            <h3 class="text-lg font-bold text-blue-900 mb-3 flex items-center gap-2">
                                <span class="text-2xl">🎯</span> 2. リスク分析とアクションプラン
                            </h3>
                            <p class="text-xs text-blue-700 mb-4">システムが PDSA、アクションプラン、改善案、結論と推奨事項の4部構成で生成します。</p>
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">入力データ:</label>
                            <textarea id="planInput" class="w-full p-4 border border-blue-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none h-24 bg-white mb-4 shadow-inner font-mono text-slate-600" placeholder="分析結果を待機中..."></textarea>
                            <div class="flex gap-2">
                                <button onclick="exportToWord()" class="w-full bg-white hover:bg-slate-50 text-blue-700 border border-blue-200 font-bold py-3 px-4 rounded-xl transition shadow-md flex justify-center items-center gap-2 transform active:scale-95" title="Word形式で書き出す">
                                    <span class="text-lg">📄</span>
                                    <span class="md:inline">Wordで書き出す</span>
                                </button>
                            </div>

                            <div class="mt-6 rounded-xl border border-blue-100 bg-white shadow-lg overflow-hidden">
                              <div id="planResult" class="hidden p-5 text-sm text-slate-700 min-h-[100px] overflow-x-auto"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
            <div class="mt-20 flex items-center justify-center">
                <div class="h-px w-24 bg-slate-300"></div>
                <span class="px-4 text-slate-400 text-sm font-semibold tracking-wider uppercase">ディープ・ダイブ知識</span>
                <div class="h-px w-24 bg-slate-300"></div>
            </div>
        </section>

        <section>
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-slate-800">1. 核となるコンセプトの詳細</h2>
                <div class="h-1 w-20 bg-teal-500 mx-auto mt-4 rounded-full"></div>
                <p class="text-slate-600 mt-4 max-w-3xl mx-auto">
                    個人を責めることなく、「事故がどのように起こるか」と「どのように防ぐか」を可視化するための6つの安全の柱を理解します。
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">

                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-cyan-500 hover:shadow-xl transition group">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">🐟</span>
                        <h3 class="font-bold text-2xl text-slate-800">1. フィッシュボーン図 (石川図)</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-6">
                        <strong>石川馨博士</strong>がRCAのために開発したツールです。医療分野では、以下の <strong>6つのM</strong> に焦点を当てます：
                    </p>
                    
                    <div class="w-full overflow-hidden bg-slate-50 rounded-xl border border-slate-200 p-2 mb-4 flex justify-center">
                        <svg viewBox="0 0 800 350" class="w-full h-auto drop-shadow-sm">
                            <line x1="50" y1="175" x2="650" y2="175" stroke="#334155" stroke-width="4" />
                            <polygon points="650,130 790,175 650,220" fill="#0EA5E9" />
                            <text x="705" y="172" font-family="sans-serif" font-size="16" font-weight="bold" fill="white" text-anchor="middle">問題</text>
                            <text x="705" y="195" font-family="sans-serif" font-size="12" fill="#E0F2FE" text-anchor="middle">(結果)</text>
                            <line x1="150" y1="50" x2="200" y2="175" stroke="#64748B" stroke-width="2" />
                            <rect x="100" y="20" width="100" height="30" rx="5" fill="white" stroke="#64748B" />
                            <text x="150" y="40" font-family="sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">人 (Man)</text>
                            <line x1="350" y1="50" x2="400" y2="175" stroke="#64748B" stroke-width="2" />
                            <rect x="300" y="20" width="100" height="30" rx="5" fill="white" stroke="#64748B" />
                            <text x="350" y="40" font-family="sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">機械 (Machine)</text>
                            <line x1="550" y1="50" x2="600" y2="175" stroke="#64748B" stroke-width="2" />
                            <rect x="500" y="20" width="100" height="30" rx="5" fill="white" stroke="#64748B" />
                            <text x="550" y="40" font-family="sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">方法 (Method)</text>
                            <line x1="150" y1="300" x2="200" y2="175" stroke="#64748B" stroke-width="2" />
                            <rect x="100" y="300" width="100" height="30" rx="5" fill="white" stroke="#64748B" />
                            <text x="150" y="320" font-family="sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">材料 (Material)</text>
                            <line x1="450" y1="300" x2="500" y2="175" stroke="#64748B" stroke-width="2" />
                            <rect x="400" y="300" width="120" height="30" rx="5" fill="white" stroke="#64748B" />
                            <text x="460" y="320" font-family="sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">環境 (Environment)</text>
                        </svg>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs text-slate-600 bg-cyan-50 p-4 rounded-xl border border-cyan-100">
                        <div>
                            <strong class="text-cyan-800">1. 人 (Man):</strong>
                            <p>職員の能力、疲労、ストレス、配置レベル、トレーニング。</p>
                        </div>
                        <div>
                            <strong class="text-cyan-800">2. 機械 (Machine):</strong>
                            <p>故障、校正の問題、メンテナンス不足、使いやすさの設計。</p>
                        </div>
                        <div>
                            <strong class="text-cyan-800">3. 方法 (Method):</strong>
                            <p>不明確なSOP、古いガイドライン、不十分なコミュニケーション・プロトコル。</p>
                        </div>
                        <div>
                            <strong class="text-cyan-800">4. 材料 (Material):</strong>
                            <p>欠陥のある薬剤、類似したパッケージ、低品質の消耗品。</p>
                        </div>
                        <div>
                            <strong class="text-cyan-800">5. 環境 (Environment):</strong>
                            <p>騒音、照明、レイアウト、注意散漫、温度。</p>
                        </div>
                        <div>
                            <strong class="text-cyan-800">6. 測定 (Measurement):</strong>
                            <p>データの正確性、検査結果の解釈、指標の妥当性。</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-pink-500 hover:shadow-xl transition group">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">❓</span>
                        <h3 class="font-bold text-2xl text-slate-800">2. なぜなぜ分析 (5 Whys)</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        <strong>豊田佐吉氏</strong> (トヨタ) によって開発された手法で、フィッシュボーン図で特定された特定の問題を掘り下げ、「なぜ？」を5回繰り返すことで真の根本原因を見つけ出します。
                    </p>
                    <div class="bg-pink-50 p-4 rounded-lg border border-pink-100">
                        <strong class="text-pink-800 block mb-2 text-sm">例：患者が転倒した。</strong>
                        <div class="space-y-0">
                            <div class="why-step">
                                <div class="why-number">1</div><div class="why-line"></div>
                                <div class="text-sm text-slate-700 pt-1">なぜ？ 床が濡れていた。</div>
                            </div>
                            <div class="why-step">
                                <div class="why-number">2</div><div class="why-line"></div>
                                <div class="text-sm text-slate-700 pt-1">なぜ？ パイプから水が漏れていた。</div>
                            </div>
                            <div class="why-step">
                                <div class="why-number">3</div><div class="why-line"></div>
                                <div class="text-sm text-slate-700 pt-1">なぜ？ シール材が破損した。</div>
                            </div>
                            <div class="why-step">
                                <div class="why-number">4</div><div class="why-line"></div>
                                <div class="text-sm text-slate-700 pt-1">なぜ？ 安価なシール材を購入した。</div>
                            </div>
                            <div class="why-step">
                                <div class="why-number">5</div>
                                <div class="text-sm text-slate-700 pt-1 font-bold text-pink-700">根本原因：調達方針が品質ではなく最低価格を優先している。</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-green-600 hover:shadow-xl transition group">
                  <div class="flex items-center gap-3 mb-4">
                    <span class="text-4xl">🎄</span>
                    <h3 class="font-bold text-2xl text-slate-800">3. クリスマスツリー図 (FTA)</h3>
                  </div>
                  <p class="text-xs text-slate-500 mb-3">失敗の経路を視覚的にマップ化</p>
                  <div class="bg-green-50 p-6 rounded-xl border border-green-200 flex flex-col items-center overflow-x-auto">
                    <div class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md z-10 text-center">...トップイベント（事故）の特定...</div>
                    <div class="h-6 w-0.5 bg-slate-400"></div>
                    <div class="bg-slate-800 text-white text-[10px] px-2 py-0.5 rounded z-10 relative">OR ゲート</div>
                    <div class="h-4 w-0.5 bg-slate-400"></div>
                    <div class="w-64 h-0.5 bg-slate-400"></div>
                    <div class="flex justify-between w-full max-w-md gap-4">
                      <div class="flex flex-col items-center w-1/2">
                        <div class="h-4 w-0.5 bg-slate-400"></div>
                        <div class="bg-white border-2 border-green-500 text-green-800 px-3 py-2 rounded-lg text-xs font-bold shadow-sm text-center">...直接的原因 A...</div>
                      </div>
                      <div class="flex flex-col items-center w-1/2">
                        <div class="h-4 w-0.5 bg-slate-400"></div>
                        <div class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded z-10 relative">AND ゲート</div>
                        <div class="h-4 w-0.5 bg-slate-400"></div>
                        <div class="w-24 h-0.5 bg-slate-400"></div>
                        <div class="flex justify-between w-full gap-2">
                          <div class="flex flex-col items-center">
                            <div class="h-3 w-0.5 bg-slate-400"></div>
                            <div class="bg-white border border-green-500 text-green-700 px-2 py-1 rounded text-[10px] text-center">...根本原因 1...</div>
                          </div>
                          <div class="flex flex-col items-center">
                            <div class="h-3 w-0.5 bg-slate-400"></div>
                            <div class="bg-white border border-green-500 text-green-700 px-2 py-1 rounded text-[10px] text-center">...根本原因 2...</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-amber-500 hover:shadow-xl transition group">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">🧀</span>
                        <h3 class="font-bold text-2xl text-slate-800">4. スイスチーズ・モデル</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-6">
                        <strong>ジェームズ・リーズン氏のモデル：</strong> 複数の防御層の「穴」（弱点）が一列に並び、ハザードが通り抜けたときに事故が発生します。
                    </p>

                    <div class="w-full overflow-hidden bg-slate-50 rounded-xl border border-slate-200 p-6 mb-6 flex justify-center">
                        <svg viewBox="0 0 800 320" class="w-full h-auto drop-shadow-sm">
                            <defs>
                                <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#EF4444" />
                                </marker>
                            </defs>
                            <line x1="50" y1="140" x2="720" y2="140" stroke="#EF4444" stroke-width="4" stroke-dasharray="10,5" marker-end="url(#arrowRed)" />
                            <text x="50" y="120" font-family="sans-serif" font-size="14" font-weight="bold" fill="#EF4444">ハザード</text>
                            <g transform="translate(150, 40)">
                                <rect x="0" y="0" width="70" height="200" rx="4" fill="#FEF3C7" stroke="#334155" stroke-width="2" />
                                <circle cx="35" cy="40" r="10" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="20" cy="180" r="8" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="35" cy="100" r="15" fill="white" stroke="#EF4444" stroke-width="2" stroke-dasharray="4,2" />
                                <text x="35" y="230" font-family="sans-serif" font-size="12" font-weight="bold" fill="#334155" text-anchor="middle">組織の方針</text>
                            </g>
                            <g transform="translate(300, 40)">
                                <rect x="0" y="0" width="70" height="200" rx="4" fill="#FDE68A" stroke="#334155" stroke-width="2" />
                                <circle cx="20" cy="50" r="9" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="50" cy="160" r="11" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="35" cy="100" r="15" fill="white" stroke="#EF4444" stroke-width="2" stroke-dasharray="4,2" />
                                <text x="35" y="230" font-family="sans-serif" font-size="12" font-weight="bold" fill="#334155" text-anchor="middle">管理・監督</text>
                            </g>
                            <g transform="translate(450, 40)">
                                <rect x="0" y="0" width="70" height="200" rx="4" fill="#FCD34D" stroke="#334155" stroke-width="2" />
                                <circle cx="45" cy="30" r="8" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="25" cy="170" r="10" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="35" cy="100" r="15" fill="white" stroke="#EF4444" stroke-width="2" stroke-dasharray="4,2" />
                                <text x="35" y="230" font-family="sans-serif" font-size="12" font-weight="bold" fill="#334155" text-anchor="middle">前提条件</text>
                            </g>
                            <g transform="translate(600, 40)">
                                <rect x="0" y="0" width="70" height="200" rx="4" fill="#F59E0B" stroke="#334155" stroke-width="2" />
                                <circle cx="20" cy="60" r="12" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="50" cy="150" r="9" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="35" cy="100" r="15" fill="white" stroke="#EF4444" stroke-width="2" stroke-dasharray="4,2" />
                                <text x="35" y="230" font-family="sans-serif" font-size="12" font-weight="bold" fill="#334155" text-anchor="middle">行動</text>
                            </g>
                            <g transform="translate(740, 140)">
                                <path d="M0 -20 L5 -5 L20 0 L5 5 L0 20 L-5 5 L-20 0 L-5 -5 Z" fill="#EF4444" stroke="#991B1B" stroke-width="2" />
                                <text x="0" y="40" font-family="sans-serif" font-size="14" font-weight="bold" fill="#EF4444" text-anchor="middle">損害・損失</text>
                            </g>
                        </svg>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs text-slate-600 bg-amber-50 p-4 rounded-xl border border-amber-100">
                        <div>
                            <strong class="text-amber-800">1. 組織的な影響:</strong>
                            <p>リソース配分、組織文化、方針。</p>
                        </div>
                        <div>
                            <strong class="text-amber-800">2. 不安全な監督:</strong>
                            <p>不適切な訓練、不備のあるスケジューリング、問題の放置。</p>
                        </div>
                        <div>
                            <strong class="text-amber-800">3. 前提条件:</strong>
                            <p>疲労、ストレス、過度な業務量、不備のある機器設計。</p>
                        </div>
                        <div>
                            <strong class="text-amber-800">4. 不安全な行為:</strong>
                            <p>スリップ、ラプス（ど忘れ）、間違い、または手順違反。</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-teal-500 hover:shadow-xl transition group">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">⚖️</span>
                        <h3 class="font-bold text-2xl text-slate-800">5. ジャスト・カルチャー (正義の文化)</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        公正な文化は、3種類の行動（ヒューマンエラー、リスクを伴う行動、無謀な行動）を区別し、適切に対応します。
                    </p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600 border border-slate-200 rounded-lg">
                            <thead class="bg-slate-100 text-slate-700 font-bold">
                                <tr>
                                    <th class="p-2 border-b">行動の種類</th>
                                    <th class="p-2 border-b">対応・管理</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b bg-green-50">
                                    <td class="p-2 font-bold text-green-700">ヒューマンエラー</td>
                                    <td class="p-2">慰め・支援 (Console)</td>
                                </tr>
                                <tr class="border-b bg-yellow-50">
                                    <td class="p-2 font-bold text-yellow-700">リスクを伴う行動</td>
                                    <td class="p-2">教育・指導 (Coach)</td>
                                </tr>
                                <tr class="bg-red-50">
                                    <td class="p-2 font-bold text-red-700">無謀な行動</td>
                                    <td class="p-2">懲戒・処分 (Punish)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                 <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-blue-500 hover:shadow-xl transition group">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">📐</span> <h3 class="font-bold text-2xl text-slate-800">6. 人間工学 (HFE)</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        人間（間違いを犯すもの）を変えようとするのではなく、<strong>人間工学</strong>は、人間の能力と限界に合わせて<strong>システム、機器、作業環境を設計</strong>することに焦点を当てます。
                    </p>
                    
                    <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 text-sm">
                        <strong class="text-blue-800 block mb-3 text-base">主要な工学的戦略：</strong>
                        <ul class="space-y-3">
                            <li class="flex items-start gap-3">
                                <div class="bg-white p-1 rounded border border-blue-200 shadow-sm text-lg">🔒</div>
                                <div>
                                    <strong class="text-slate-700">フールプルーフ (Forcing Functions)</strong>
                                    <p class="text-slate-500 text-xs mt-0.5">エラーが不可能な設計（例：異なるポートには物理的に接続できないコネクタ）。</p>
                                </div>
                            </li>
                            <li class="flex items-start gap-3">
                                <div class="bg-white p-1 rounded border border-blue-200 shadow-sm text-lg">📏</div>
                                <div>
                                    <strong class="text-slate-700">標準化 (Standardization)</strong>
                                    <p class="text-slate-500 text-xs mt-0.5">機器やレイアウトの統一（例：すべての救急カートを同一配置にする）により、認知負荷を軽減。</p>
                                </div>
                            </li>
                            <li class="flex items-start gap-3">
                                <div class="bg-white p-1 rounded border border-blue-200 shadow-sm text-lg">🔊</div>
                                <div>
                                    <strong class="text-slate-700">使いやすさとアラート</strong>
                                    <p class="text-slate-500 text-xs mt-0.5">直感的な表示と明確なアラームを設計し、ストレス下での混乱を防ぐ。</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-indigo-600 hover:shadow-xl transition group">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">🧩</span> <h3 class="font-bold text-2xl text-slate-800">7. 寄与因子 (Contributing Factors)</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-6">
                        イベントに影響を与えた潜在的な条件を特定します。これらはそれ自体が「原因」ではありませんが、エラーが発生する可能性を高めます。
                    </p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        
                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <strong class="text-indigo-800 flex items-center gap-2">
                                <i class="fas fa-user-injured"></i> 患者要因
                            </strong>
                            <p class="text-xs text-slate-600 mt-2">臨床状態、複雑さ、コミュニケーションの壁、社会的要因。</p>
                        </div>

                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <strong class="text-indigo-800 flex items-center gap-2">
                                <i class="fas fa-tasks"></i> タスクと技術
                            </strong>
                            <p class="text-xs text-slate-600 mt-2">プロトコル設計、検査結果の可用性、機器の操作性。</p>
                        </div>

                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <strong class="text-indigo-800 flex items-center gap-2">
                                <i class="fas fa-user-nurse"></i> 個人要因
                            </strong>
                            <p class="text-xs text-slate-600 mt-2">知識、スキル、疲労、ストレス、身体的健康。</p>
                        </div>

                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <strong class="text-indigo-800 flex items-center gap-2">
                                <i class="fas fa-users"></i> チーム要因
                            </strong>
                            <p class="text-xs text-slate-600 mt-2">言語的コミュニケーション、記録、監督、助けを求める文化。</p>
                        </div>

                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <strong class="text-indigo-800 flex items-center gap-2">
                                <i class="fas fa-hospital"></i> 作業環境
                            </strong>
                            <p class="text-xs text-slate-600 mt-2">人員配置、業務量、騒音、照明、管理的サポート。</p>
                        </div>

                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <strong class="text-indigo-800 flex items-center gap-2">
                                <i class="fas fa-sitemap"></i> 組織と管理
                            </strong>
                            <p class="text-xs text-slate-600 mt-2">安全文化、優先順位、方針、財務的制約。</p>
                        </div>

                    </div>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-rose-500 hover:shadow-xl transition group">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">🔮</span> <h3 class="font-bold text-2xl text-slate-800">8. FMEA (将来の予防)</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        <strong>故障モード影響解析：</strong> RCAが過去の問題を解決するために「後ろ」を振り返るのに対し、FMEAは将来の失敗を予測し、発生する「前」に防ぐために<strong>「前」</strong>を見ます。
                    </p>

                    <div class="bg-rose-50 border-l-4 border-rose-500 p-4 mb-6 rounded-r-lg">
                        <strong class="text-rose-700 text-sm uppercase tracking-wide">🚀 使用時期:</strong>
                        <p class="text-rose-800 text-sm mt-1">
                            新しいアクションプランを設計した<strong>後</strong>（ステップ2の後）に、その解決策を全院展開する前に「ストレス・テスト」としてFMEAを使用します。
                        </p>
                    </div>

                    <div class="bg-white border border-rose-100 rounded-xl p-4 shadow-sm">
                        <div class="text-center mb-3">
                            <span class="text-xs font-bold text-slate-400 uppercase">リスク算出式 (RPN)</span>
                        </div>
                        <div class="flex flex-wrap justify-center items-center gap-2 md:gap-4 text-center">
                            
                            <div class="bg-rose-100 p-3 rounded-lg w-24">
                                <div class="text-2xl font-bold text-rose-600">S</div>
                                <div class="text-[10px] text-rose-800 font-bold mt-1">影響度</div>
                                <div class="text-[9px] text-rose-600">(どの程度深刻か)</div>
                            </div>

                            <div class="text-slate-300 text-xl">✖</div>

                            <div class="bg-rose-100 p-3 rounded-lg w-24">
                                <div class="text-2xl font-bold text-rose-600">O</div>
                                <div class="text-[10px] text-rose-800 font-bold mt-1">頻度</div>
                                <div class="text-[9px] text-rose-600">(どの位起こるか)</div>
                            </div>

                            <div class="text-slate-300 text-xl">✖</div>

                            <div class="bg-rose-100 p-3 rounded-lg w-24">
                                <div class="text-2xl font-bold text-rose-600">D</div>
                                <div class="text-[10px] text-rose-800 font-bold mt-1">検出難易度</div>
                                <div class="text-[9px] text-rose-600">(気づけるか)</div>
                            </div>

                            <div class="text-slate-400 text-xl">=</div>

                            <div class="bg-slate-800 p-3 rounded-lg w-28 shadow-md">
                                <div class="text-2xl font-bold text-white">RPN</div>
                                <div class="text-[10px] text-slate-300 mt-1">リスク優先順位</div>
                            </div>
                        </div>
                    </div>
                </div>
        </section>

        <section class="bg-white rounded-3xl shadow-xl p-8 md:p-12 border border-slate-200">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
                <div class="lg:col-span-5 space-y-6">
                    <h2 class="text-3xl font-bold text-slate-800">2. 評価とステータス</h2>
                    <div class="h-1 w-20 bg-teal-500 rounded-full"></div>
                    <p class="text-slate-600 leading-relaxed font-light italic border-l-4 border-teal-500 pl-4 bg-teal-50/50 p-2 rounded-r-lg">
                        「<strong>AHRQ HSOPSC 2.0</strong> (10の評価項目) に基づきます。各項目の実際的な <strong>『肯定的回答率 (%)』</strong> を入力してください。チャートは、現実と理想（100%）の間のギャップを明らかにします。」
                    </p>
                    
                    <div class="bg-slate-100 p-4 rounded-xl border border-slate-200 max-h-[500px] overflow-y-auto">
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 tracking-wide flex items-center gap-2 sticky top-0 bg-slate-100 py-2 border-b">
                            <span>🎚️</span> 肯定的回答率 (%) を入力
                        </h4>
                        <div class="space-y-4 text-sm">
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">1. チームワーク</label>
                                    <span id="val-0" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(0, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">2. 人員配置と業務スピード</label>
                                    <span id="val-1" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(1, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">3. 組織的な学習</label>
                                    <span id="val-2" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(2, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">4. エラーへの対応</label>
                                    <span id="val-3" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(3, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">5. 上司のサポート</label>
                                    <span id="val-4" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(4, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">6. エラーに関する伝達</label>
                                    <span id="val-5" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(5, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">7. コミュニケーションの開放性</label>
                                    <span id="val-6" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(6, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">8. 安全イベントの報告</label>
                                    <span id="val-7" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(7, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">9. 病院経営層のサポート</label>
                                    <span id="val-8" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(8, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">10. 申し送りと情報交換</label>
                                    <span id="val-9" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(9, this.value)">
                            </div>
                        </div>
                    </div>

                    <div class="chart-container mt-6">
                        <canvas id="assessmentChart"></canvas>
                    </div>
                    <p class="text-xs text-center text-slate-400 mt-2">インタラクティブ：あなたの回答率 vs 100% の理想</p>
                </div>

                <div class="lg:col-span-7 space-y-6">
                    <h3 class="xl font-bold text-slate-700 border-l-4 border-teal-500 pl-4">ギャップ分析と解決策</h3>
                    <div class="space-y-4">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <div class="flex items-start gap-3">
                                <div class="bg-red-100 text-red-600 p-2 rounded-lg font-bold text-xl">⚠️</div>
                                <div>
                                    <h4 class="font-bold text-slate-800">非懲罰的なエラーへの対応</h4>
                                    <p class="text-sm text-slate-600 mt-1"><strong>問題点:</strong> 職員が報告による処罰を恐れ、過少報告やリスクの隠蔽につながっています。</p>
                                    <div class="mt-3 bg-white p-3 rounded border border-slate-200 text-sm">
                                        <strong class="text-teal-600">✅ 解決策:</strong>
                                        <ul class="list-disc list-inside text-slate-500 mt-1">
                                            <li>経営層による「非難なし」の方針宣言。</li>
                                            <li><strong>代用テスト</strong>の実施（他の有資格者も同じミスを犯すか？ Yesなら＝システムの問題）。</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <div class="flex items-start gap-3">
                                <div class="bg-amber-100 text-amber-600 p-2 rounded-lg font-bold text-xl">⚡</div>
                                <div>
                                    <h4 class="font-bold text-slate-800">人員配置と業務負荷</h4>
                                    <p class="text-sm text-slate-600 mt-1"><strong>問題点:</strong> 過度な業務負荷が疲労を招き、近道（手順省略）への依存を助長しています。</p>
                                    <div class="mt-3 bg-white p-3 rounded border border-slate-200 text-sm">
                                        <strong class="text-teal-600">✅ 解決策:</strong>
                                        <ul class="list-disc list-inside text-slate-500 mt-1">
                                            <li>シフトスケジュールの最適化（ダブルシフトの回避）。</li>
                                            <li>自動化技術の活用による事務作業の削減と患者ケア時間の確保。</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-8">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-slate-800">3. 導入ロードマップ</h2>
                <div class="h-1 w-20 bg-blue-500 mx-auto mt-4 rounded-full"></div>
                <p class="text-slate-600 mt-4">組織文化を体系的に変革するための 3フェーズ戦略計画。</p>
            </div>

            <div class="relative max-w-5xl mx-auto pl-8 md:pl-0">
                <div class="timeline-line hidden md:block" style="left: 50%; transform: translateX(-50%);"></div>
                
                <div class="relative grid grid-cols-1 md:grid-cols-2 gap-8 mb-16">
                    <div class="md:text-right md:pr-12 order-1">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-teal-500 relative">
                            <h3 class="text-xl font-bold text-teal-700">フェーズ 1: 信頼の構築</h3>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">期間: 1-3ヶ月目</span>
                            <p class="text-sm text-slate-600 mt-3 leading-relaxed">
                                リーダーと職員の意識を変え、安全に関する開かれた対話を促進することに焦点を当てます。
                            </p>
                            <div class="mt-4 pt-4 border-t border-slate-100 text-left">
                                <strong class="text-sm text-slate-700 block mb-2">🚀 主な活動:</strong>
                                <ul class="text-sm text-slate-600 space-y-2">
                                    <li>🔹 <strong>経営層による安全巡回：</strong> リーダーが現場を訪れ、命令ではなく「傾聴」します。</li>
                                    <li>🔹 <strong>脱・犯人捜しキャンペーン：</strong> 「誰が」ではなく「何が（システムの欠陥）」に焦点を移します。</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="absolute left-0 md:left-1/2 -translate-x-1/2 top-6 w-10 h-10 bg-teal-500 rounded-full border-4 border-white shadow-md z-10 flex items-center justify-center text-white font-bold">1</div>
                    <div class="hidden md:block order-2"></div>
                </div>

                <div class="relative grid grid-cols-1 md:grid-cols-2 gap-8 mb-16">
                    <div class="hidden md:block order-1"></div>
                    <div class="absolute left-0 md:left-1/2 -translate-x-1/2 top-6 w-10 h-10 bg-blue-500 rounded-full border-4 border-white shadow-md z-10 flex items-center justify-center text-white font-bold">2</div>
                    <div class="md:pl-12 order-2">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-blue-500 relative">
                            <h3 class="text-xl font-bold text-blue-700">フェーズ 2: 報告システムの確立</h3>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">期間: 4-6ヶ月目</span>
                            <p class="text-sm text-slate-600 mt-3 leading-relaxed">
                                報告を「簡単」かつ「有意義」なものにし、「報告し損」を防ぎます。
                            </p>
                            <div class="mt-4 pt-4 border-t border-slate-100 text-left">
                                <strong class="text-sm text-slate-700 block mb-2">🚀 主な活動:</strong>
                                <ul class="text-sm text-slate-600 space-y-2">
                                    <li>🔹 <strong>IRフォームの簡素化：</strong> 入力時間を2分以内に短縮します。</li>
                                    <li>🔹 <strong>グッドジョブ賞：</strong> ヒヤリ・ハットを報告した職員を表彰します。</li>
                                    <li>🔹 <strong>フィードバック・ループ：</strong> 対策状況を7日以内に報告者にフィードバックします。</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="relative grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="md:text-right md:pr-12 order-1">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-amber-500 relative">
                            <h3 class="text-xl font-bold text-amber-600">フェーズ 3: 持続と学習</h3>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">期間: 7ヶ月目以降</span>
                            <p class="text-sm text-slate-600 mt-3 leading-relaxed">
                                対症療法的な問題解決から、予防的な学習（プロアクティブ・ラーニング）へと移行します。
                            </p>
                            <div class="mt-4 pt-4 border-t border-slate-100 text-left">
                                <strong class="text-sm text-slate-700 block mb-2">🚀 主な活動:</strong>
                                <ul class="text-sm text-slate-600 space-y-2">
                                    <li>🔹 <strong>セーフティ・ハドル：</strong> 毎朝5-10分の短いミーティングでリスクを確認します。</li>
                                    <li>🔹 <strong>RCAの徹底：</strong> 個人を責めずにシステムの真因を分析します。</li>
                                    <li>🔹 <strong>成功事例の共有：</strong> 「Safety-II」の視点で成功体験を他部署と共有します。</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="absolute left-0 md:left-1/2 -translate-x-1/2 top-6 w-10 h-10 bg-amber-500 rounded-full border-4 border-white shadow-md z-10 flex items-center justify-center text-white font-bold">3</div>
                    <div class="hidden md:block order-2"></div>
                </div>
            </div>
        </section>

    </main>

    <div class="container mx-auto px-4 pb-6">
      <div class="bg-slate-50 border border-slate-200 rounded-2xl p-5 shadow-sm">
        <p class="text-indigo-700 font-bold italic mb-1">
          免責事項:
        </p>
        <p class="text-slate-600 text-sm leading-relaxed">
          本書の図表および内容は、公衆衛生サービスの分析および質向上のための初期ガイドとして、AI支援（AI-Assisted）により生成されました。
          利用者は内容を確認・検証し、組織の文脈に適応させ、実践に際しては関連する専門的基準を参照してください。
        </p>
      </div>
    </div>

    <script>
        // --- Core Gemini API Call Function (PROXY VERSION) ---
        async function callGemini(prompt) {
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(`Server Error: ${errData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) { 
                console.error(error);
                throw error; 
            }
        }
        function sanitizeLLMHtml(text) {
          return String(text ?? "")
            .replace(/```(?:html)?/gi, "")
            .replace(/```/g, "")
            .trim();
        }
        
        function stripHtml(html) {
          const tmp = document.createElement("div");
          tmp.innerHTML = html;
          return (tmp.textContent || tmp.innerText || "").trim();
        }
        
        function looksLikeRiskAnalysis(html) {
          return (
            html.includes("1. Event Summary") || html.includes("イベントの概要") &&
            html.includes("Fishbone Diagram") || html.includes("フィッシュボーン図") &&
            html.includes("5 Whys") || html.includes("なぜなぜ分析") &&
            html.length > 300
          );
        }

        async function startFullAnalysis() {
            const input = document.getElementById('scenarioInput').value;
            const runButton = document.getElementById('combinedRunButton'); // ตรงนี้ต้องตรงกับ ID ปุ่มข้างบน
            const spinner = document.getElementById('runSpinner'); // ตรงนี้ต้องตรงกับ ID ของ span
            const resultDiv = document.getElementById('analyzeResult');
            const planInput = document.getElementById('planInput');
            const planResultDiv = document.getElementById('planResult');
            
            if (!input.trim()) { alert("内容を入力してください"); return; }
        
            // เริ่มการทำงาน: ปิดปุ่ม และโชว์ตัวหมุน
            runButton.disabled = true;
            spinner.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            planResultDiv.classList.add('hidden');
            planInput.value = '分析中...';
        
            try {
                // ส่วนนี้สั่งให้ AI วิเคราะห์
                const promptAnalysis = `Act as a Patient Safety Expert. Analyze this scenario in Japanese HTML: "${input}". Include: 1. Event Summary, 2. Timeline, 3. Fishbone (using <div class="fishbone-grid">), 4. 5 Whys.`;
                const resText = await callGemini(promptAnalysis);
                const htmlContent = resText.replace(/```html/g, '').replace(/```/g, '');
                
                resultDiv.innerHTML = htmlContent;
                resultDiv.classList.remove('hidden');
                
                // เตรียมข้อมูลส่งต่อให้ Step 2
                const cleanText = resultDiv.innerText;
                planInput.value = 'アクションプラン生成中...';
                
                const promptPlan = `Based on: "${cleanText}", create a PDSA Action Plan in Japanese HTML with tables.`;
                const resPlan = await callGemini(promptPlan);
                const planHtml = resPlan.replace(/```html/g, '').replace(/```/g, '');
                
                planResultDiv.innerHTML = planHtml;
                planResultDiv.classList.remove('hidden');
                planInput.value = '✔ 完了しました';
        
            } catch (error) {
                console.error(error);
                alert("エラー: " + error.message);
                planInput.value = "Failed";
            } finally {
                // จบการทำงาน: เปิดปุ่ม และซ่อนตัวหมุน
                spinner.classList.add('hidden');
                runButton.disabled = false;
            }
        }

        async function analyzeRiskStep(input) {
            const prompt = `あなたは医療安全の専門家（RCA担当）として振る舞ってください。
            以下の医療シナリオを日本語で分析してください: "${input}"。
            
            HTML形式で日本語で出力してください。Markdownコードブロックは使用しないでください。
            以下の構造に従ってください:
            
            <h3 class="font-bold text-lg text-teal-700 mb-2">1. イベントの概要</h3>
            <p class="mb-2 text-slate-600">...イベントの記述的要約...</p>
            <ul class="list-disc pl-5 mb-4 text-slate-600 space-y-1">
                <li>...重要ポイント 1...</li>
            </ul>

            <h3 class="font-bold text-lg text-teal-700 mb-2">2. イベントのタイムライン</h3>
            <ol class="list-decimal pl-5 mb-4 text-slate-600 space-y-1">
                <li>...詳細なステップ 1...</li>
            </ol>

            <h3 class="font-bold text-lg text-amber-700 mb-2">3. フィッシュボーン図（石川図）</h3>
            <div class="fishbone-grid">
                <div class="fishbone-card"><div class="fishbone-header">👤 人 (Man)</div><ul class="list-disc pl-4 text-xs text-slate-600"><li>...要因...</li></ul></div>
                <div class="fishbone-card"><div class="fishbone-header">⚙️ 機械 (Machine)</div><ul class="list-disc pl-4 text-xs text-slate-600"><li>...要因...</li></ul></div>
                <div class="fishbone-card"><div class="fishbone-header">📝 方法 (Method)</div><ul class="list-disc pl-4 text-xs text-slate-600"><li>...要因...</li></ul></div>
                <div class="fishbone-card"><div class="fishbone-header">📦 材料 (Material)</div><ul class="list-disc pl-4 text-xs text-slate-600"><li>...要因...</li></ul></div>
                <div class="fishbone-card"><div class="fishbone-header">🌡️ 環境 (Environment)</div><ul class="list-disc pl-4 text-xs text-slate-600"><li>...要因...</li></ul></div>
                <div class="fishbone-card"><div class="fishbone-header">📏 測定 (Measurement)</div><ul class="list-disc pl-4 text-xs text-slate-600"><li>...要因...</li></ul></div>
            </div>

            <h3 class="font-bold text-lg text-pink-600 mb-2">4. なぜなぜ分析 (5 Whys)</h3>
            <div class="bg-pink-50 p-4 rounded-lg border border-pink-100 mb-4">
                 <div class="why-step"><div class="why-number">1</div><div class="why-line"></div><div class="text-sm text-slate-700 pt-1">なぜ...</div></div>
                 <div class="why-step"><div class="why-number">5</div><div class="text-sm text-slate-700 pt-1 font-bold text-pink-700">根本原因: ...</div></div>
            </div>
            <h3 class="font-bold text-lg text-green-700 mb-2">5. スイスチーズ・モデル分析</h3>
            <table class="rca-table">
              <thead><tr><th>システム層</th><th>タイプ</th><th>説明</th></tr></thead>
              <tbody>
                <tr><td><strong>組織的な影響</strong></td><td>潜在的</td><td>...</td></tr>
                <tr><td><strong>不安全な行為</strong></td><td>顕在的</td><td>...</td></tr>
              </tbody>
            </table>`;

            const responseText = await callGemini(prompt);
            let formattedText = responseText.replace(/```html/g, '').replace(/```/g, '');
            const cleanText = responseText.replace(/<[^>]*>?/gm, ''); 
            return { html: formattedText, cleanText: cleanText };
        }

        async function generateActionPlanStep(analysisData) {
            const prompt = `あなたは病院の安全管理者です。
            分析データ: "${analysisData}" に基づき、日本語のHTMLで、PDSA、詳細プラン、改善案、結論を含むレスポンスを作成してください。`;

            try {
                const responseText = await callGemini(prompt);
                return responseText.replace(/```html/g, '').replace(/```/g, '');
            } catch (error) {
                console.error("Action Plan Error:", error);
                throw new Error(`アクションプランの生成に失敗しました: ${error.message}`);
            }
        }

        function exportToWord() {
            const scenario = document.getElementById('scenarioInput').value;
            const riskAnalysis = document.getElementById('analyzeResult').innerHTML;
            const actionPlan = document.getElementById('planResult').innerHTML;

            if (!actionPlan) { alert("分析を先に完了させてください。"); return; }

            const content = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head><meta charset='utf-8'><title>医療安全アクションプラン</title></head>
                <body style="font-family: Arial, sans-serif;">
                    <h1>安全アクションプラン報告書</h1>
                    <h2>1. リスク分析</h2>
                    <p><strong>シナリオ:</strong> ${scenario}</p>
                    ${riskAnalysis}
                    <h2>2. アクションプランと改善案</h2>
                    ${actionPlan}
                </body>
                </html>
            `;
            const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Safety_Plan_${new Date().toISOString().slice(0,10)}.doc`;
            link.click();
        }

        Chart.defaults.font.family = "'Noto Sans JP', sans-serif";
        const ctx = document.getElementById('assessmentChart');
        const assessmentChart = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels: ['チームワーク', '人員配置', '組織的学習', 'エラーへの対応', '上司のサポート', '伝達', '開放性', '報告', '経営層サポート', '申し送り'], 
                datasets: [
                    { label: '自院の現状 (%)', data: [0,0,0,0,0,0,0,0,0,0], backgroundColor: '#0D9488', borderRadius: 4 }, 
                    { label: '目標 (100%)', data: [100,100,100,100,100,100,100,100,100,100], backgroundColor: '#E2E8F0', borderRadius: 4 }
                ] 
            },
            options: { 
                indexAxis: 'y', responsive: true, maintainAspectRatio: false, 
                scales: { x: { suggestedMin: 0, max: 100 }, y: { grid: { display: false } } }
            }
        });

        function updateChartData(index, value) {
            document.getElementById(`val-${index}`).innerText = parseFloat(value).toFixed(2) + '%';
            assessmentChart.data.datasets[0].data[index] = value;
            assessmentChart.update();
        }
    </script>
</body>
</html>
