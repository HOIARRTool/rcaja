<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RCA ã‚¤ãƒ³ã‚µã‚¤ãƒˆãƒ»ã‚³ãƒ³ãƒ‘ãƒ‹ã‚ªãƒ³</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Noto Sans JP', sans-serif; background-color: #F8FAFC; }

    .loader {
      border: 3px solid #f3f3f3;
      border-radius: 50%;
      border-top: 3px solid #0EA5E9;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* --- âœ… Results container: desktop = no horizontal scroll, mobile = scroll if needed --- */
    #analyzeResult, #planResult {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }
    @media (max-width: 768px) {
      #analyzeResult, #planResult { overflow-x: auto; }
    }

    /* --- âœ… Fix table overflow: remove min-width and force wrapping --- */
    table {
      width: 100% !important;
      max-width: 100% !important;
      border-collapse: collapse;
      table-layout: fixed; /* IMPORTANT: prevents table from expanding wider than container */
    }
    th, td {
      vertical-align: top;
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
    }

    /* --- Optional: Improve readability for generated tables --- */
    .rca-table, .pdsatable {
      width: 100% !important;
      border: 1px solid #E2E8F0;
      border-radius: 12px;
      overflow: hidden;
    }
    .rca-table th, .rca-table td,
    .pdsatable th, .pdsatable td {
      border-bottom: 1px solid #E2E8F0;
      padding: 10px;
      font-size: 0.875rem;
    }
    .rca-table thead th, .pdsatable thead th {
      background: #F1F5F9;
      font-weight: 700;
      color: #334155;
    }

    /* --- Fishbone grid styles (because LLM output uses fishbone-grid) --- */
    .fishbone-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-bottom: 14px;
    }
    @media (min-width: 768px) {
      .fishbone-grid { grid-template-columns: 1fr 1fr; }
    }
    .fishbone-card {
      background: #FFFFFF;
      border: 1px solid #E2E8F0;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .fishbone-header {
      font-weight: 800;
      color: #0F172A;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    /* --- 5 Whys visual --- */
    .why-step { display: flex; align-items: flex-start; gap: 10px; margin: 6px 0; }
    .why-number {
      width: 26px; height: 26px;
      border-radius: 9999px;
      background: #FBCFE8;
      color: #9D174D;
      display: flex; align-items: center; justify-content: center;
      font-weight: 800;
      flex: 0 0 auto;
      margin-top: 2px;
    }
    .why-line { width: 10px; border-left: 2px solid #FDA4AF; margin-top: 6px; }

    /* --- Mobile typography adjustments --- */
    @media (max-width: 640px) {
      h2 { font-size: 1.25rem !important; line-height: 1.4 !important; }
      .md\:p-10 { padding: 1rem !important; }
      .p-6 { padding: 1rem !important; }
      table td, table th {
        font-size: 0.75rem !important;
        padding: 8px 6px !important;
      }
    }
  </style>
</head>

<body class="bg-slate-50">

  <!-- âœ… Full width layout (desktop also full width) -->
  <main class="w-full px-4 2xl:px-12 pt-10 pb-16 relative z-20">

    <section id="ai-lab">
      <div class="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-3xl p-1 shadow-2xl overflow-hidden">
        <div class="bg-white rounded-[20px] p-6 md:p-10">

          <div class="text-center mb-10">
            <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ»ã‚µãƒãƒ¼ãƒˆ</span>
            <h2 class="text-3xl md:text-4xl font-extrabold text-slate-800 mt-4 mb-2 flex items-center justify-center gap-3">
              <span>âœ¨</span> RCA ã‚¤ãƒ³ã‚µã‚¤ãƒˆãƒ»ã‚³ãƒ³ãƒ‘ãƒ‹ã‚ªãƒ³
            </h2>
            <p class="text-slate-500 max-w-2xl mx-auto">
              æ·±ã„å­¦ç¿’ã€æ ¹æœ¬åŸå› åˆ†æã€ãã—ã¦å…±ã«ã‚ˆã‚Šå®‰å…¨ãªã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ã€ã‚ãªãŸã®å¿ƒå¼·ã„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã€‚
            </p>
          </div>

          <!-- âœ… Single column FULL width (Step1 then Step2) -->
          <div class="flex flex-col gap-8 w-full">
          
            <!-- Step 1 -->
            <div class="space-y-6">
              <div class="bg-slate-50 rounded-2xl p-6 border border-slate-200 shadow-sm">
                <h3 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2">
                  <span class="text-2xl">ğŸ¥</span> 1. ç—…é™¢ã®ãƒªã‚¹ã‚¯ã¾ãŸã¯ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒ»ãƒ¬ãƒãƒ¼ãƒˆ
                </h3>
          
                <textarea id="scenarioInput" class="w-full p-4 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-amber-500 outline-none mb-4 bg-white" rows="6" placeholder="ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
          
                <button id="combinedRunButton" onclick="startFullAnalysis()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg flex justify-center items-center gap-2 transform active:scale-95">
                  <span id="runSpinner" class="loader hidden border-white border-t-transparent"></span>
                  <span>ğŸ” RCAåˆ†æã‚’é–‹å§‹</span>
                </button>
          
                <div id="analyzeResult" class="hidden mt-4 p-4 text-sm text-slate-700 bg-white rounded-xl border border-amber-100"></div>
              </div>
            </div>
          
            <!-- Step 2 -->
            <div class="bg-blue-50 rounded-2xl p-6 border-2 border-blue-100 shadow-md relative overflow-hidden h-full">
              <div class="absolute top-0 right-0 bg-blue-200 text-blue-800 text-[10px] font-bold px-2 py-1 rounded-bl-lg">ã‚¹ãƒ†ãƒƒãƒ— 2 (è‡ªå‹•)</div>
          
              <h3 class="text-lg font-bold text-blue-900 mb-3 flex items-center gap-2">
                <span class="text-2xl">ğŸ¯</span> 2. ãƒªã‚¹ã‚¯åˆ†æã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³
              </h3>
          
              <p class="text-xs text-blue-700 mb-4">
                ã‚·ã‚¹ãƒ†ãƒ ãŒ PDSAã€Action Planã€Initiative Ideasã€Conclusion & Recommendations ã®4éƒ¨æ§‹æˆã§ç”Ÿæˆã—ã¾ã™ã€‚
              </p>
          
              <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">å…¥åŠ›ãƒ‡ãƒ¼ã‚¿:</label>
              <textarea id="planInput" class="w-full p-4 border border-blue-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none h-24 bg-white mb-4 shadow-inner font-mono text-slate-600" placeholder="åˆ†æçµæœã‚’å¾…æ©Ÿä¸­..."></textarea>
          
              <div class="flex gap-2">
                <button onclick="exportToWord()" class="w-full bg-white hover:bg-slate-50 text-blue-700 border border-blue-200 font-bold py-3 px-4 rounded-xl transition shadow-md flex justify-center items-center gap-2 transform active:scale-95" title="Wordå½¢å¼ã§æ›¸ãå‡ºã™">
                  <span class="text-lg">ğŸ“„</span>
                  <span class="md:inline">Wordã§æ›¸ãå‡ºã™</span>
                </button>
              </div>
          
              <div class="mt-6 rounded-xl border border-blue-100 bg-white shadow-lg overflow-hidden">
                <div id="planResult" class="hidden p-5 text-sm text-slate-700 min-h-[100px]"></div>
              </div>
            </div>          
          </div

      <div class="mt-20 flex items-center justify-center">
        <div class="h-px w-24 bg-slate-300"></div>
        <span class="px-4 text-slate-400 text-sm font-semibold tracking-wider uppercase">ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ»ãƒ€ã‚¤ãƒ–çŸ¥è­˜</span>
        <div class="h-px w-24 bg-slate-300"></div>
      </div>
    </section>

    <!-- ======= Deep knowledge sections (unchanged content) ======= -->
    <section>
      <div class="text-center mb-12">
        <h2 class="text-3xl font-bold text-slate-800">1. æ ¸ã¨ãªã‚‹ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®è©³ç´°</h2>
        <div class="h-1 w-20 bg-teal-500 mx-auto mt-4 rounded-full"></div>
        <p class="text-slate-600 mt-4 max-w-3xl mx-auto">
          å€‹äººã‚’è²¬ã‚ã‚‹ã“ã¨ãªãã€ã€Œäº‹æ•…ãŒã©ã®ã‚ˆã†ã«èµ·ã“ã‚‹ã‹ã€ã¨ã€Œã©ã®ã‚ˆã†ã«é˜²ãã‹ã€ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®6ã¤ã®å®‰å…¨ã®æŸ±ã‚’ç†è§£ã—ã¾ã™ã€‚
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">

        <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-cyan-500 hover:shadow-xl transition group">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-4xl">ğŸŸ</span>
            <h3 class="font-bold text-2xl text-slate-800">1. ãƒ•ã‚£ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ³å›³ (çŸ³å·å›³)</h3>
          </div>
          <p class="text-slate-600 leading-relaxed mb-6">
            <strong>çŸ³å·é¦¨åšå£«</strong>ãŒRCAã®ãŸã‚ã«é–‹ç™ºã—ãŸãƒ„ãƒ¼ãƒ«ã§ã™ã€‚åŒ»ç™‚åˆ†é‡ã§ã¯ã€ä»¥ä¸‹ã® <strong>6ã¤ã®M</strong> ã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ï¼š
          </p>

          <div class="w-full overflow-hidden bg-slate-50 rounded-xl border border-slate-200 p-2 mb-4 flex justify-center">
            <svg viewBox="0 0 800 350" class="w-full h-auto drop-shadow-sm">
              <line x1="50" y1="175" x2="650" y2="175" stroke="#334155" stroke-width="4" />
              <polygon points="650,130 790,175 650,220" fill="#0EA5E9" />
              <text x="705" y="172" font-family="sans-serif" font-size="16" font-weight="bold" fill="white" text-anchor="middle">å•é¡Œ</text>
              <text x="705" y="195" font-family="sans-serif" font-size="12" fill="#E0F2FE" text-anchor="middle">(çµæœ)</text>
              <line x1="150" y1="50" x2="200" y2="175" stroke="#64748B" stroke-width="2" />
              <rect x="100" y="20" width="100" height="30" rx="5" fill="white" stroke="#64748B" />
              <text x="150" y="40" font-family="sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">äºº (Man)</text>
              <line x1="350" y1="50" x2="400" y2="175" stroke="#64748B" stroke-width="2" />
              <rect x="300" y="20" width="100" height="30" rx="5" fill="white" stroke="#64748B" />
              <text x="350" y="40" font-family="sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">æ©Ÿæ¢° (Machine)</text>
              <line x1="550" y1="50" x2="600" y2="175" stroke="#64748B" stroke-width="2" />
              <rect x="500" y="20" width="100" height="30" rx="5" fill="white" stroke="#64748B" />
              <text x="550" y="40" font-family="sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">æ–¹æ³• (Method)</text>
              <line x1="150" y1="300" x2="200" y2="175" stroke="#64748B" stroke-width="2" />
              <rect x="100" y="300" width="100" height="30" rx="5" fill="white" stroke="#64748B" />
              <text x="150" y="320" font-family="sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">ææ–™ (Material)</text>
              <line x1="450" y1="300" x2="500" y2="175" stroke="#64748B" stroke-width="2" />
              <rect x="400" y="300" width="120" height="30" rx="5" fill="white" stroke="#64748B" />
              <text x="460" y="320" font-family="sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">ç’°å¢ƒ (Environment)</text>
            </svg>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs text-slate-600 bg-cyan-50 p-4 rounded-xl border border-cyan-100">
            <div><strong class="text-cyan-800">1. äºº (Man):</strong><p>è·å“¡ã®èƒ½åŠ›ã€ç–²åŠ´ã€ã‚¹ãƒˆãƒ¬ã‚¹ã€é…ç½®ãƒ¬ãƒ™ãƒ«ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€‚</p></div>
            <div><strong class="text-cyan-800">2. æ©Ÿæ¢° (Machine):</strong><p>æ•…éšœã€æ ¡æ­£ã®å•é¡Œã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸è¶³ã€ä½¿ã„ã‚„ã™ã•ã®è¨­è¨ˆã€‚</p></div>
            <div><strong class="text-cyan-800">3. æ–¹æ³• (Method):</strong><p>ä¸æ˜ç¢ºãªSOPã€å¤ã„ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã€ä¸ååˆ†ãªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€‚</p></div>
            <div><strong class="text-cyan-800">4. ææ–™ (Material):</strong><p>æ¬ é™¥ã®ã‚ã‚‹è–¬å‰¤ã€é¡ä¼¼ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€ä½å“è³ªã®æ¶ˆè€—å“ã€‚</p></div>
            <div><strong class="text-cyan-800">5. ç’°å¢ƒ (Environment):</strong><p>é¨’éŸ³ã€ç…§æ˜ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã€æ³¨æ„æ•£æ¼«ã€æ¸©åº¦ã€‚</p></div>
            <div><strong class="text-cyan-800">6. æ¸¬å®š (Measurement):</strong><p>ãƒ‡ãƒ¼ã‚¿ã®æ­£ç¢ºæ€§ã€æ¤œæŸ»çµæœã®è§£é‡ˆã€æŒ‡æ¨™ã®å¦¥å½“æ€§ã€‚</p></div>
          </div>
        </div>

        <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-pink-500 hover:shadow-xl transition group">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-4xl">â“</span>
            <h3 class="font-bold text-2xl text-slate-800">2. ãªãœãªãœåˆ†æ (5 Whys)</h3>
          </div>
          <p class="text-slate-600 leading-relaxed mb-4">
            <strong>è±Šç”°ä½å‰æ°</strong> (ãƒˆãƒ¨ã‚¿) ã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚ŒãŸæ‰‹æ³•ã§ã€ãƒ•ã‚£ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ³å›³ã§ç‰¹å®šã•ã‚ŒãŸç‰¹å®šã®å•é¡Œã‚’æ˜ã‚Šä¸‹ã’ã€ã€Œãªãœï¼Ÿã€ã‚’5å›ç¹°ã‚Šè¿”ã™ã“ã¨ã§çœŸã®æ ¹æœ¬åŸå› ã‚’è¦‹ã¤ã‘å‡ºã—ã¾ã™ã€‚
          </p>
          <div class="bg-pink-50 p-4 rounded-lg border border-pink-100">
            <strong class="text-pink-800 block mb-2 text-sm">ä¾‹ï¼šæ‚£è€…ãŒè»¢å€’ã—ãŸã€‚</strong>
            <div class="space-y-0">
              <div class="why-step"><div class="why-number">1</div><div class="why-line"></div><div class="text-sm text-slate-700 pt-1">ãªãœï¼Ÿ åºŠãŒæ¿¡ã‚Œã¦ã„ãŸã€‚</div></div>
              <div class="why-step"><div class="why-number">2</div><div class="why-line"></div><div class="text-sm text-slate-700 pt-1">ãªãœï¼Ÿ ãƒ‘ã‚¤ãƒ—ã‹ã‚‰æ°´ãŒæ¼ã‚Œã¦ã„ãŸã€‚</div></div>
              <div class="why-step"><div class="why-number">3</div><div class="why-line"></div><div class="text-sm text-slate-700 pt-1">ãªãœï¼Ÿ ã‚·ãƒ¼ãƒ«æãŒç ´æã—ãŸã€‚</div></div>
              <div class="why-step"><div class="why-number">4</div><div class="why-line"></div><div class="text-sm text-slate-700 pt-1">ãªãœï¼Ÿ å®‰ä¾¡ãªã‚·ãƒ¼ãƒ«æã‚’è³¼å…¥ã—ãŸã€‚</div></div>
              <div class="why-step"><div class="why-number">5</div><div class="text-sm text-slate-700 pt-1 font-bold text-pink-700">æ ¹æœ¬åŸå› ï¼šèª¿é”æ–¹é‡ãŒå“è³ªã§ã¯ãªãæœ€ä½ä¾¡æ ¼ã‚’å„ªå…ˆã—ã¦ã„ã‚‹ã€‚</div></div>
            </div>
          </div>
        </div>

        <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-green-600 hover:shadow-xl transition group">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-4xl">ğŸ„</span>
            <h3 class="font-bold text-2xl text-slate-800">3. ã‚¯ãƒªã‚¹ãƒã‚¹ãƒ„ãƒªãƒ¼å›³ (FTA)</h3>
          </div>
          <p class="text-xs text-slate-500 mb-3">å¤±æ•—ã®çµŒè·¯ã‚’è¦–è¦šçš„ã«ãƒãƒƒãƒ—åŒ–</p>
          <div class="bg-green-50 p-6 rounded-xl border border-green-200 flex flex-col items-center overflow-x-auto">
            <div class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md z-10 text-center">...ãƒˆãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆäº‹æ•…ï¼‰ã®ç‰¹å®š...</div>
            <div class="h-6 w-0.5 bg-slate-400"></div>
            <div class="bg-slate-800 text-white text-[10px] px-2 py-0.5 rounded z-10 relative">OR ã‚²ãƒ¼ãƒˆ</div>
            <div class="h-4 w-0.5 bg-slate-400"></div>
            <div class="w-64 h-0.5 bg-slate-400"></div>
            <div class="flex justify-between w-full max-w-md gap-4">
              <div class="flex flex-col items-center w-1/2">
                <div class="h-4 w-0.5 bg-slate-400"></div>
                <div class="bg-white border-2 border-green-500 text-green-800 px-3 py-2 rounded-lg text-xs font-bold shadow-sm text-center">...ç›´æ¥çš„åŸå›  A...</div>
              </div>
              <div class="flex flex-col items-center w-1/2">
                <div class="h-4 w-0.5 bg-slate-400"></div>
                <div class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded z-10 relative">AND ã‚²ãƒ¼ãƒˆ</div>
                <div class="h-4 w-0.5 bg-slate-400"></div>
                <div class="w-24 h-0.5 bg-slate-400"></div>
                <div class="flex justify-between w-full gap-2">
                  <div class="flex flex-col items-center">
                    <div class="h-3 w-0.5 bg-slate-400"></div>
                    <div class="bg-white border border-green-500 text-green-700 px-2 py-1 rounded text-[10px] text-center">...æ ¹æœ¬åŸå›  1...</div>
                  </div>
                  <div class="flex flex-col items-center">
                    <div class="h-3 w-0.5 bg-slate-400"></div>
                    <div class="bg-white border border-green-500 text-green-700 px-2 py-1 rounded text-[10px] text-center">...æ ¹æœ¬åŸå›  2...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-amber-500 hover:shadow-xl transition group">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-4xl">ğŸ§€</span>
            <h3 class="font-bold text-2xl text-slate-800">4. ã‚¹ã‚¤ã‚¹ãƒãƒ¼ã‚ºãƒ»ãƒ¢ãƒ‡ãƒ«</h3>
          </div>
          <p class="text-slate-600 leading-relaxed mb-6">
            <strong>ã‚¸ã‚§ãƒ¼ãƒ ã‚ºãƒ»ãƒªãƒ¼ã‚ºãƒ³æ°ã®ãƒ¢ãƒ‡ãƒ«ï¼š</strong> è¤‡æ•°ã®é˜²å¾¡å±¤ã®ã€Œç©´ã€ï¼ˆå¼±ç‚¹ï¼‰ãŒä¸€åˆ—ã«ä¸¦ã³ã€ãƒã‚¶ãƒ¼ãƒ‰ãŒé€šã‚ŠæŠœã‘ãŸã¨ãã«äº‹æ•…ãŒç™ºç”Ÿã—ã¾ã™ã€‚
          </p>

          <div class="w-full overflow-hidden bg-slate-50 rounded-xl border border-slate-200 p-6 mb-6 flex justify-center">
            <svg viewBox="0 0 800 320" class="w-full h-auto drop-shadow-sm">
              <defs>
                <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                  <polygon points="0 0, 10 3.5, 0 7" fill="#EF4444" />
                </marker>
              </defs>
              <line x1="50" y1="140" x2="720" y2="140" stroke="#EF4444" stroke-width="4" stroke-dasharray="10,5" marker-end="url(#arrowRed)" />
              <text x="50" y="120" font-family="sans-serif" font-size="14" font-weight="bold" fill="#EF4444">ãƒã‚¶ãƒ¼ãƒ‰</text>
              <g transform="translate(150, 40)">
                <rect x="0" y="0" width="70" height="200" rx="4" fill="#FEF3C7" stroke="#334155" stroke-width="2" />
                <circle cx="35" cy="40" r="10" fill="white" stroke="#334155" stroke-width="1" />
                <circle cx="20" cy="180" r="8" fill="white" stroke="#334155" stroke-width="1" />
                <circle cx="35" cy="100" r="15" fill="white" stroke="#EF4444" stroke-width="2" stroke-dasharray="4,2" />
                <text x="35" y="230" font-family="sans-serif" font-size="12" font-weight="bold" fill="#334155" text-anchor="middle">çµ„ç¹”ã®æ–¹é‡</text>
              </g>
              <g transform="translate(300, 40)">
                <rect x="0" y="0" width="70" height="200" rx="4" fill="#FDE68A" stroke="#334155" stroke-width="2" />
                <circle cx="20" cy="50" r="9" fill="white" stroke="#334155" stroke-width="1" />
                <circle cx="50" cy="160" r="11" fill="white" stroke="#334155" stroke-width="1" />
                <circle cx="35" cy="100" r="15" fill="white" stroke="#EF4444" stroke-width="2" stroke-dasharray="4,2" />
                <text x="35" y="230" font-family="sans-serif" font-size="12" font-weight="bold" fill="#334155" text-anchor="middle">ç®¡ç†ãƒ»ç›£ç£</text>
              </g>
              <g transform="translate(450, 40)">
                <rect x="0" y="0" width="70" height="200" rx="4" fill="#FCD34D" stroke="#334155" stroke-width="2" />
                <circle cx="45" cy="30" r="8" fill="white" stroke="#334155" stroke-width="1" />
                <circle cx="25" cy="170" r="10" fill="white" stroke="#334155" stroke-width="1" />
                <circle cx="35" cy="100" r="15" fill="white" stroke="#EF4444" stroke-width="2" stroke-dasharray="4,2" />
                <text x="35" y="230" font-family="sans-serif" font-size="12" font-weight="bold" fill="#334155" text-anchor="middle">å‰ææ¡ä»¶</text>
              </g>
              <g transform="translate(600, 40)">
                <rect x="0" y="0" width="70" height="200" rx="4" fill="#F59E0B" stroke="#334155" stroke-width="2" />
                <circle cx="20" cy="60" r="12" fill="white" stroke="#334155" stroke-width="1" />
                <circle cx="50" cy="150" r="9" fill="white" stroke="#334155" stroke-width="1" />
                <circle cx="35" cy="100" r="15" fill="white" stroke="#EF4444" stroke-width="2" stroke-dasharray="4,2" />
                <text x="35" y="230" font-family="sans-serif" font-size="12" font-weight="bold" fill="#334155" text-anchor="middle">è¡Œå‹•</text>
              </g>
              <g transform="translate(740, 140)">
                <path d="M0 -20 L5 -5 L20 0 L5 5 L0 20 L-5 5 L-20 0 L-5 -5 Z" fill="#EF4444" stroke="#991B1B" stroke-width="2" />
                <text x="0" y="40" font-family="sans-serif" font-size="14" font-weight="bold" fill="#EF4444" text-anchor="middle">æå®³ãƒ»æå¤±</text>
              </g>
            </svg>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs text-slate-600 bg-amber-50 p-4 rounded-xl border border-amber-100">
            <div><strong class="text-amber-800">1. çµ„ç¹”çš„ãªå½±éŸ¿:</strong><p>ãƒªã‚½ãƒ¼ã‚¹é…åˆ†ã€çµ„ç¹”æ–‡åŒ–ã€æ–¹é‡ã€‚</p></div>
            <div><strong class="text-amber-800">2. ä¸å®‰å…¨ãªç›£ç£:</strong><p>ä¸é©åˆ‡ãªè¨“ç·´ã€ä¸å‚™ã®ã‚ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã€å•é¡Œã®æ”¾ç½®ã€‚</p></div>
            <div><strong class="text-amber-800">3. å‰ææ¡ä»¶:</strong><p>ç–²åŠ´ã€ã‚¹ãƒˆãƒ¬ã‚¹ã€éåº¦ãªæ¥­å‹™é‡ã€ä¸å‚™ã®ã‚ã‚‹æ©Ÿå™¨è¨­è¨ˆã€‚</p></div>
            <div><strong class="text-amber-800">4. ä¸å®‰å…¨ãªè¡Œç‚º:</strong><p>ã‚¹ãƒªãƒƒãƒ—ã€ãƒ©ãƒ—ã‚¹ï¼ˆã©å¿˜ã‚Œï¼‰ã€é–“é•ã„ã€ã¾ãŸã¯æ‰‹é †é•åã€‚</p></div>
          </div>
        </div>

        <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-teal-500 hover:shadow-xl transition group">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-4xl">âš–ï¸</span>
            <h3 class="font-bold text-2xl text-slate-800">5. ã‚¸ãƒ£ã‚¹ãƒˆãƒ»ã‚«ãƒ«ãƒãƒ£ãƒ¼ (æ­£ç¾©ã®æ–‡åŒ–)</h3>
          </div>
          <p class="text-slate-600 leading-relaxed mb-4">
            å…¬æ­£ãªæ–‡åŒ–ã¯ã€3ç¨®é¡ã®è¡Œå‹•ï¼ˆãƒ’ãƒ¥ãƒ¼ãƒãƒ³ã‚¨ãƒ©ãƒ¼ã€ãƒªã‚¹ã‚¯ã‚’ä¼´ã†è¡Œå‹•ã€ç„¡è¬€ãªè¡Œå‹•ï¼‰ã‚’åŒºåˆ¥ã—ã€é©åˆ‡ã«å¯¾å¿œã—ã¾ã™ã€‚
          </p>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-slate-600 border border-slate-200 rounded-lg">
              <thead class="bg-slate-100 text-slate-700 font-bold">
                <tr>
                  <th class="p-2 border-b">è¡Œå‹•ã®ç¨®é¡</th>
                  <th class="p-2 border-b">å¯¾å¿œãƒ»ç®¡ç†</th>
                </tr>
              </thead>
              <tbody>
                <tr class="border-b bg-green-50">
                  <td class="p-2 font-bold text-green-700">ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ã‚¨ãƒ©ãƒ¼</td>
                  <td class="p-2">æ…°ã‚ãƒ»æ”¯æ´ (Console)</td>
                </tr>
                <tr class="border-b bg-yellow-50">
                  <td class="p-2 font-bold text-yellow-700">ãƒªã‚¹ã‚¯ã‚’ä¼´ã†è¡Œå‹•</td>
                  <td class="p-2">æ•™è‚²ãƒ»æŒ‡å° (Coach)</td>
                </tr>
                <tr class="bg-red-50">
                  <td class="p-2 font-bold text-red-700">ç„¡è¬€ãªè¡Œå‹•</td>
                  <td class="p-2">æ‡²æˆ’ãƒ»å‡¦åˆ† (Punish)</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-blue-500 hover:shadow-xl transition group">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-4xl">ğŸ“</span>
            <h3 class="font-bold text-2xl text-slate-800">6. äººé–“å·¥å­¦ (HFE)</h3>
          </div>
          <p class="text-slate-600 leading-relaxed mb-4">
            äººé–“ï¼ˆé–“é•ã„ã‚’çŠ¯ã™ã‚‚ã®ï¼‰ã‚’å¤‰ãˆã‚ˆã†ã¨ã™ã‚‹ã®ã§ã¯ãªãã€<strong>äººé–“å·¥å­¦</strong>ã¯ã€äººé–“ã®èƒ½åŠ›ã¨é™ç•Œã«åˆã‚ã›ã¦<strong>ã‚·ã‚¹ãƒ†ãƒ ã€æ©Ÿå™¨ã€ä½œæ¥­ç’°å¢ƒã‚’è¨­è¨ˆ</strong>ã™ã‚‹ã“ã¨ã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚
          </p>

          <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 text-sm">
            <strong class="text-blue-800 block mb-3 text-base">ä¸»è¦ãªå·¥å­¦çš„æˆ¦ç•¥ï¼š</strong>
            <ul class="space-y-3">
              <li class="flex items-start gap-3">
                <div class="bg-white p-1 rounded border border-blue-200 shadow-sm text-lg">ğŸ”’</div>
                <div>
                  <strong class="text-slate-700">ãƒ•ãƒ¼ãƒ«ãƒ—ãƒ«ãƒ¼ãƒ• (Forcing Functions)</strong>
                  <p class="text-slate-500 text-xs mt-0.5">ã‚¨ãƒ©ãƒ¼ãŒä¸å¯èƒ½ãªè¨­è¨ˆï¼ˆä¾‹ï¼šç•°ãªã‚‹ãƒãƒ¼ãƒˆã«ã¯ç‰©ç†çš„ã«æ¥ç¶šã§ããªã„ã‚³ãƒã‚¯ã‚¿ï¼‰ã€‚</p>
                </div>
              </li>
              <li class="flex items-start gap-3">
                <div class="bg-white p-1 rounded border border-blue-200 shadow-sm text-lg">ğŸ“</div>
                <div>
                  <strong class="text-slate-700">æ¨™æº–åŒ– (Standardization)</strong>
                  <p class="text-slate-500 text-xs mt-0.5">æ©Ÿå™¨ã‚„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®çµ±ä¸€ï¼ˆä¾‹ï¼šã™ã¹ã¦ã®æ•‘æ€¥ã‚«ãƒ¼ãƒˆã‚’åŒä¸€é…ç½®ã«ã™ã‚‹ï¼‰ã«ã‚ˆã‚Šã€èªçŸ¥è² è·ã‚’è»½æ¸›ã€‚</p>
                </div>
              </li>
              <li class="flex items-start gap-3">
                <div class="bg-white p-1 rounded border border-blue-200 shadow-sm text-lg">ğŸ”Š</div>
                <div>
                  <strong class="text-slate-700">ä½¿ã„ã‚„ã™ã•ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ</strong>
                  <p class="text-slate-500 text-xs mt-0.5">ç›´æ„Ÿçš„ãªè¡¨ç¤ºã¨æ˜ç¢ºãªã‚¢ãƒ©ãƒ¼ãƒ ã‚’è¨­è¨ˆã—ã€ã‚¹ãƒˆãƒ¬ã‚¹ä¸‹ã§ã®æ··ä¹±ã‚’é˜²ãã€‚</p>
                </div>
              </li>
            </ul>
          </div>
        </div>

        <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-indigo-600 hover:shadow-xl transition group">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-4xl">ğŸ§©</span>
            <h3 class="font-bold text-2xl text-slate-800">7. å¯„ä¸å› å­ (Contributing Factors)</h3>
          </div>
          <p class="text-slate-600 leading-relaxed mb-6">
            ã‚¤ãƒ™ãƒ³ãƒˆã«å½±éŸ¿ã‚’ä¸ãˆãŸæ½œåœ¨çš„ãªæ¡ä»¶ã‚’ç‰¹å®šã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ãã‚Œè‡ªä½“ãŒã€ŒåŸå› ã€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ã‚’é«˜ã‚ã¾ã™ã€‚
          </p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
              <strong class="text-indigo-800 flex items-center gap-2">æ‚£è€…è¦å› </strong>
              <p class="text-xs text-slate-600 mt-2">è‡¨åºŠçŠ¶æ…‹ã€è¤‡é›‘ã•ã€ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å£ã€ç¤¾ä¼šçš„è¦å› ã€‚</p>
            </div>
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
              <strong class="text-indigo-800 flex items-center gap-2">ã‚¿ã‚¹ã‚¯ã¨æŠ€è¡“</strong>
              <p class="text-xs text-slate-600 mt-2">ãƒ—ãƒ­ãƒˆã‚³ãƒ«è¨­è¨ˆã€æ¤œæŸ»çµæœã®å¯ç”¨æ€§ã€æ©Ÿå™¨ã®æ“ä½œæ€§ã€‚</p>
            </div>
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
              <strong class="text-indigo-800 flex items-center gap-2">å€‹äººè¦å› </strong>
              <p class="text-xs text-slate-600 mt-2">çŸ¥è­˜ã€ã‚¹ã‚­ãƒ«ã€ç–²åŠ´ã€ã‚¹ãƒˆãƒ¬ã‚¹ã€èº«ä½“çš„å¥åº·ã€‚</p>
            </div>
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
              <strong class="text-indigo-800 flex items-center gap-2">ãƒãƒ¼ãƒ è¦å› </strong>
              <p class="text-xs text-slate-600 mt-2">è¨€èªçš„ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€è¨˜éŒ²ã€ç›£ç£ã€åŠ©ã‘ã‚’æ±‚ã‚ã‚‹æ–‡åŒ–ã€‚</p>
            </div>
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
              <strong class="text-indigo-800 flex items-center gap-2">ä½œæ¥­ç’°å¢ƒ</strong>
              <p class="text-xs text-slate-600 mt-2">äººå“¡é…ç½®ã€æ¥­å‹™é‡ã€é¨’éŸ³ã€ç…§æ˜ã€ç®¡ç†çš„ã‚µãƒãƒ¼ãƒˆã€‚</p>
            </div>
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
              <strong class="text-indigo-800 flex items-center gap-2">çµ„ç¹”ã¨ç®¡ç†</strong>
              <p class="text-xs text-slate-600 mt-2">å®‰å…¨æ–‡åŒ–ã€å„ªå…ˆé †ä½ã€æ–¹é‡ã€è²¡å‹™çš„åˆ¶ç´„ã€‚</p>
            </div>
          </div>
        </div>

        <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-rose-500 hover:shadow-xl transition group">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-4xl">ğŸ”®</span>
            <h3 class="font-bold text-2xl text-slate-800">8. FMEA (å°†æ¥ã®äºˆé˜²)</h3>
          </div>
          <p class="text-slate-600 leading-relaxed mb-4">
            <strong>æ•…éšœãƒ¢ãƒ¼ãƒ‰å½±éŸ¿è§£æï¼š</strong> RCAãŒéå»ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€Œå¾Œã‚ã€ã‚’æŒ¯ã‚Šè¿”ã‚‹ã®ã«å¯¾ã—ã€FMEAã¯å°†æ¥ã®å¤±æ•—ã‚’äºˆæ¸¬ã—ã€ç™ºç”Ÿã™ã‚‹ã€Œå‰ã€ã«é˜²ããŸã‚ã«<strong>ã€Œå‰ã€</strong>ã‚’è¦‹ã¾ã™ã€‚
          </p>

          <div class="bg-rose-50 border-l-4 border-rose-500 p-4 mb-6 rounded-r-lg">
            <strong class="text-rose-700 text-sm uppercase tracking-wide">ğŸš€ ä½¿ç”¨æ™‚æœŸ:</strong>
            <p class="text-rose-800 text-sm mt-1">
              æ–°ã—ã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ã‚’è¨­è¨ˆã—ãŸ<strong>å¾Œ</strong>ï¼ˆã‚¹ãƒ†ãƒƒãƒ—2ã®å¾Œï¼‰ã«ã€ãã®è§£æ±ºç­–ã‚’å…¨é™¢å±•é–‹ã™ã‚‹å‰ã«ã€Œã‚¹ãƒˆãƒ¬ã‚¹ãƒ»ãƒ†ã‚¹ãƒˆã€ã¨ã—ã¦FMEAã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
            </p>
          </div>

          <div class="bg-white border border-rose-100 rounded-xl p-4 shadow-sm">
            <div class="text-center mb-3">
              <span class="text-xs font-bold text-slate-400 uppercase">ãƒªã‚¹ã‚¯ç®—å‡ºå¼ (RPN)</span>
            </div>
            <div class="flex flex-wrap justify-center items-center gap-2 md:gap-4 text-center">
              <div class="bg-rose-100 p-3 rounded-lg w-24">
                <div class="text-2xl font-bold text-rose-600">S</div>
                <div class="text-[10px] text-rose-800 font-bold mt-1">å½±éŸ¿åº¦</div>
                <div class="text-[9px] text-rose-600">(ã©ã®ç¨‹åº¦æ·±åˆ»ã‹)</div>
              </div>
              <div class="text-slate-300 text-xl">âœ–</div>
              <div class="bg-rose-100 p-3 rounded-lg w-24">
                <div class="text-2xl font-bold text-rose-600">O</div>
                <div class="text-[10px] text-rose-800 font-bold mt-1">é »åº¦</div>
                <div class="text-[9px] text-rose-600">(ã©ã®ä½èµ·ã“ã‚‹ã‹)</div>
              </div>
              <div class="text-slate-300 text-xl">âœ–</div>
              <div class="bg-rose-100 p-3 rounded-lg w-24">
                <div class="text-2xl font-bold text-rose-600">D</div>
                <div class="text-[10px] text-rose-800 font-bold mt-1">æ¤œå‡ºé›£æ˜“åº¦</div>
                <div class="text-[9px] text-rose-600">(æ°—ã¥ã‘ã‚‹ã‹)</div>
              </div>
              <div class="text-slate-400 text-xl">=</div>
              <div class="bg-slate-800 p-3 rounded-lg w-28 shadow-md">
                <div class="text-2xl font-bold text-white">RPN</div>
                <div class="text-[10px] text-slate-300 mt-1">ãƒªã‚¹ã‚¯å„ªå…ˆé †ä½</div>
              </div>
            </div>
          </div>
        </div>

      </div><!-- /grid -->
    </section>

    <!-- (à¸ªà¹ˆà¸§à¸™ chart/roadmap à¸‚à¸­à¸‡à¸„à¸¸à¸“à¹€à¸”à¸´à¸¡ à¸­à¸¢à¸¹à¹ˆà¸•à¹ˆà¸­à¹„à¸”à¹‰à¸•à¸²à¸¡à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ â€” à¹„à¸¡à¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸›à¸±à¸à¸«à¸²à¸œà¸¥à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥) -->
  </main>

  <div class="w-full px-4 2xl:px-12 pb-6">
    <div class="bg-slate-50 border border-slate-200 rounded-2xl p-5 shadow-sm">
      <p class="text-indigo-700 font-bold italic mb-1">å…è²¬äº‹é …:</p>
      <p class="text-slate-600 text-sm leading-relaxed">
        æœ¬æ›¸ã®å›³è¡¨ãŠã‚ˆã³å†…å®¹ã¯ã€å…¬è¡†è¡›ç”Ÿã‚µãƒ¼ãƒ“ã‚¹ã®åˆ†æãŠã‚ˆã³è³ªå‘ä¸Šã®ãŸã‚ã®åˆæœŸã‚¬ã‚¤ãƒ‰ã¨ã—ã¦ã€AIæ”¯æ´ï¼ˆAI-Assistedï¼‰ã«ã‚ˆã‚Šç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
        åˆ©ç”¨è€…ã¯å†…å®¹ã‚’ç¢ºèªãƒ»æ¤œè¨¼ã—ã€çµ„ç¹”ã®æ–‡è„ˆã«é©å¿œã•ã›ã€å®Ÿè·µã«éš›ã—ã¦ã¯é–¢é€£ã™ã‚‹å°‚é–€çš„åŸºæº–ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
      </p>
    </div>
  </div>

  <script>
    async function callGemini(prompt) {
      const response = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });

      if (!response.ok) {
        let errData = {};
        try { errData = await response.json(); } catch (_) {}
        throw new Error(`Server Error: ${errData?.error?.message || response.statusText}`);
      }

      const data = await response.json();
      return data?.candidates?.[0]?.content?.parts?.[0]?.text ?? "";
    }

    function sanitizeLLMHtml(text) {
      return String(text ?? "")
        .replace(/```(?:html)?/gi, "")
        .replace(/```/g, "")
        .trim();
    }

    function stripHtml(html) {
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return (tmp.textContent || tmp.innerText || "").trim();
    }

    async function startFullAnalysis() {
      const input = document.getElementById('scenarioInput').value;
      const runButton = document.getElementById('combinedRunButton');
      const spinner = document.getElementById('runSpinner');
      const resultDiv = document.getElementById('analyzeResult');
      const planInput = document.getElementById('planInput');
      const planResultDiv = document.getElementById('planResult');
    
      if (!input.trim()) { alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    
      runButton.disabled = true;
      spinner.classList.remove('hidden');
      resultDiv.classList.add('hidden');
      planResultDiv.classList.add('hidden');
      planInput.value = 'åˆ†æä¸­...';
    
      try {
        // Step 1: à¸šà¸±à¸‡à¸„à¸±à¸šà¹ƒà¸«à¹‰à¸¡à¸µ Swiss Cheese à¹à¸™à¹ˆ à¹†
        const promptAnalysis = `
    ã‚ãªãŸã¯åŒ»ç™‚å®‰å…¨ã®å°‚é–€å®¶ï¼ˆRCAæ‹…å½“ï¼‰ã§ã™ã€‚
    ä»¥ä¸‹ã®åŒ»ç™‚ã‚·ãƒŠãƒªã‚ªã‚’æ—¥æœ¬èªã§åˆ†æã—ã¦ãã ã•ã„: "${input}"
    
    ã€é‡è¦ã€‘
    - å‡ºåŠ›ã¯HTMLã®ã¿ã€‚Markdownã®\`\`\`ã¯ç¦æ­¢ã€‚
    - å¿…ãšä»¥ä¸‹ã®5ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã“ã®é †ã§å«ã‚ã‚‹:
      1) ã‚¤ãƒ™ãƒ³ãƒˆã®æ¦‚è¦
      2) ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
      3) ãƒ•ã‚£ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ³å›³ï¼ˆ<div class="fishbone-grid"> ã‚’ä½¿ã†ï¼‰
      4) ãªãœãªãœåˆ†æ (5 Whys)
      5) ã‚¹ã‚¤ã‚¹ãƒãƒ¼ã‚ºãƒ»ãƒ¢ãƒ‡ãƒ«åˆ†æï¼ˆè¡¨: ã‚·ã‚¹ãƒ†ãƒ å±¤ / ã‚¿ã‚¤ãƒ— / ç©´(å¼±ç‚¹) / é˜²å¾¡ç­–ï¼‰
    
    ã€å¿…é ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
    <h3 class="font-bold text-lg text-teal-700 mb-2">1. ã‚¤ãƒ™ãƒ³ãƒˆã®æ¦‚è¦</h3>
    <h3 class="font-bold text-lg text-teal-700 mb-2">2. ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h3>
    <h3 class="font-bold text-lg text-amber-700 mb-2">3. ãƒ•ã‚£ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ³å›³ï¼ˆçŸ³å·å›³ï¼‰</h3>
    <div class="fishbone-grid">...</div>
    <h3 class="font-bold text-lg text-pink-600 mb-2">4. ãªãœãªãœåˆ†æ (5 Whys)</h3>
    <h3 class="font-bold text-lg text-green-700 mb-2">5. ã‚¹ã‚¤ã‚¹ãƒãƒ¼ã‚ºãƒ»ãƒ¢ãƒ‡ãƒ«åˆ†æ</h3>
    <table class="rca-table w-full">
      <thead><tr><th>ã‚·ã‚¹ãƒ†ãƒ å±¤</th><th>ã‚¿ã‚¤ãƒ—</th><th>ç©´ï¼ˆå¼±ç‚¹ï¼‰</th><th>é˜²å¾¡ç­–ï¼ˆææ¡ˆï¼‰</th></tr></thead>
      <tbody>...</tbody>
    </table>
    `.trim();
    
        const resText = await callGemini(promptAnalysis);
        const htmlContent = sanitizeLLMHtml(resText);
    
        resultDiv.innerHTML = htmlContent;
        resultDiv.classList.remove('hidden');
    
        const cleanText = stripHtml(htmlContent);
        planInput.value = 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ç”Ÿæˆä¸­...';
    
        // Step 2: à¸šà¸±à¸‡à¸„à¸±à¸šà¹ƒà¸«à¹‰à¸¡à¸µ 4 à¸ªà¹ˆà¸§à¸™à¸„à¸£à¸š
        const promptPlan = `
    ã‚ãªãŸã¯ç—…é™¢ã®å®‰å…¨ç®¡ç†è€…ã§ã™ã€‚
    ä»¥ä¸‹ã®åˆ†æãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€æ—¥æœ¬èªHTMLã®ã¿ã§ã€å¿…ãšæ¬¡ã®4éƒ¨æ§‹æˆã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆé †ç•ªå³å®ˆï¼‰ã€‚Markdownç¦æ­¢ã€‚
    
    åˆ†æãƒ‡ãƒ¼ã‚¿:
    "${cleanText}"
    
    (1) <h3>1. PDSA</h3>
      - Plan / Do / Study / Act ã‚’è¦‹å‡ºã—ä»˜ãã§å…·ä½“åŒ–
    
    (2) <h3>2. Action Plan</h3>
      - è¡¨å½¢å¼ï¼ˆåˆ—ã¯æœ€å¤§5åˆ—ï¼‰
      - æ–½ç­– / æ‹…å½“ / æœŸé™ / KPI(æˆæœæŒ‡æ¨™) / ãƒªã‚¹ã‚¯ã¨å¯¾ç­–
    
    (3) <h3>3. Initiative Ideas</h3>
      - Quick Wins(0-30æ—¥), Mid-term(1-3ãƒ¶æœˆ), Long-term(3-12ãƒ¶æœˆ)
    
    (4) <h3>4. Conclusion & Recommendations</h3>
      - é‡è¦åº¦é †ã«5é …ç›®
      - æœ€å¾Œã«ã€Œæ¬¡ã®ä¸€æ‰‹ï¼ˆ72æ™‚é–“ä»¥å†…ï¼‰ã€ã‚’å¿…ãšå…¥ã‚Œã‚‹
    `.trim();
    
        const resPlan = await callGemini(promptPlan);
        const planHtml = sanitizeLLMHtml(resPlan);
    
        planResultDiv.innerHTML = planHtml;
        planResultDiv.classList.remove('hidden');
        planInput.value = 'âœ” å®Œäº†ã—ã¾ã—ãŸ';
    
      } catch (error) {
        console.error(error);
        alert("ã‚¨ãƒ©ãƒ¼: " + error.message);
        planInput.value = "Failed";
      } finally {
        spinner.classList.add('hidden');
        runButton.disabled = false;
      }
    }


    function exportToWord() {
      const scenario = document.getElementById('scenarioInput').value;
      const riskAnalysis = document.getElementById('analyzeResult').innerHTML;
      const actionPlan = document.getElementById('planResult').innerHTML;

      if (!actionPlan) { alert("åˆ†æã‚’å…ˆã«å®Œäº†ã•ã›ã¦ãã ã•ã„ã€‚"); return; }

      const content = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>åŒ»ç™‚å®‰å…¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³</title></head>
        <body style="font-family: Arial, sans-serif;">
          <h1>å®‰å…¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³å ±å‘Šæ›¸</h1>
          <h2>1. ãƒªã‚¹ã‚¯åˆ†æ</h2>
          <p><strong>ã‚·ãƒŠãƒªã‚ª:</strong> ${scenario}</p>
          ${riskAnalysis}
          <h2>2. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ã¨æ”¹å–„æ¡ˆ</h2>
          ${actionPlan}
        </body>
        </html>
      `;

      const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `Safety_Plan_${new Date().toISOString().slice(0,10)}.doc`;
      link.click();
    }
  </script>
</body>
</html>
